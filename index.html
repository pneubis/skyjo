<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sky Joe â€“ Stable Definitive</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<style>
body{background:#0b1320;color:white;font-family:Arial;text-align:center}
button{margin:5px;padding:8px 15px}
.card{width:60px;height:90px;border:1px solid #888;
display:inline-flex;align-items:center;justify-content:center;
margin:5px;background:#1e2a44}
</style>
</head>
<body>

<h1>Sky Joe</h1>

<div>
<button onclick="hostGame()">CrÃ©er</button>
<input id="code" placeholder="Code">
<button onclick="joinGame()">Rejoindre</button>
</div>

<div id="game" style="display:none">
<h3>Phase : <span id="phase"></span></h3>
<h3>Cartes restantes : <span id="deckCount"></span></h3>
<div id="held"></div>
<button onclick="drawDeck()">Piocher</button>
</div>

<script>
'use strict';

/* ===============================
   Ã‰TAT GLOBAL
=================================*/

let peer=null;
let myId=null;
let isHost=false;
let conn=null;
let clients={};

let realDeck=[]; // ðŸ”¥ deck serveur uniquement

let G={
  players:[],
  deck_count:0,
  phase:'lobby',
  currentTurn:0
};

/* ===============================
   UTILS
=================================*/

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function buildDeck(){
  const d=[];
  for(let i=1;i<=12;i++)
    for(let j=0;j<5;j++)d.push(i);
  return shuffle(d);
}

/* ===============================
   SYNCHRONISATION
=================================*/

function broadcastState(){

  const payload={
    type:'state',
    state:JSON.parse(JSON.stringify(G)) // copie safe
  };

  if(isHost){
    Object.values(clients).forEach(c=>{
      if(c.open)c.send(payload);
    });
  }

  applyState(payload.state);
}

function applyState(state){

  // ðŸ”¥ jamais G = state
  G.phase = state.phase;
  G.deck_count = state.deck_count;
  G.currentTurn = state.currentTurn;
  G.players = state.players;

  render();
}

/* ===============================
   HOST
=================================*/

function hostGame(){

  isHost=true;

  const room='skyjoe-'+Math.random().toString(36).slice(2,8);

  peer=new Peer(room);

  peer.on('open',()=>{

    alert("Code: "+room.replace('skyjoe-',''));

    G.players=[{id:room}];

    realDeck=buildDeck();              // ðŸ”¥ vrai deck
    G.deck_count=realDeck.length;      // ðŸ”¥ synchro uniquement longueur
    G.phase='draw';

    document.getElementById('game').style.display='block';

    broadcastState();
  });

  peer.on('connection',c=>{
    clients[c.peer]=c;

    c.on('data',data=>{
      if(data.type==='action'){
        processAction(data.action);
      }
    });
  });
}

/* ===============================
   ACTIONS HÃ”TE
=================================*/

function processAction(action){

  if(action==='draw'){

    if(realDeck.length===0)return;

    const card=realDeck.pop();

    G.deck_count=realDeck.length;
    G.players[0].held=card;
    G.phase='place';

    broadcastState();
  }
}

/* ===============================
   CLIENT
=================================*/

function joinGame(){

  const code=document.getElementById('code').value.trim();
  if(!code)return;

  isHost=false;

  peer=new Peer();

  peer.on('open',id=>{
    myId=id;
    conn=peer.connect('skyjoe-'+code);

    conn.on('data',data=>{
      if(data.type==='state'){
        applyState(data.state);
        document.getElementById('game').style.display='block';
      }
    });
  });
}

/* ===============================
   ACTIONS
=================================*/

function drawDeck(){

  if(isHost){
    processAction('draw');
  }else{
    conn.send({type:'action',action:'draw'});
  }
}

/* ===============================
   RENDU
=================================*/

function render(){

  document.getElementById('phase').innerText=G.phase;
  document.getElementById('deckCount').innerText=G.deck_count;

  const heldDiv=document.getElementById('held');
  heldDiv.innerHTML='';

  const me=isHost?G.players[0]:G.players.find(p=>p.id===myId);

  if(me && me.held){
    const div=document.createElement('div');
    div.className='card';
    div.innerText=me.held;
    heldDiv.appendChild(div);
  }
}

</script>
</body>
</html>
