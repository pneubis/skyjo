<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sky Joe âœˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Pro:wght@300;400;600&display=swap');
:root{--bg:#06101c;--gold:#c9903a;--gold2:#f0c85e;--cloud:#ddd5c0;--back:#112255;--back-b:rgba(180,148,58,.38);--panel:rgba(13,30,60,.82);}
*{margin:0;padding:0;box-sizing:border-box;}html{font-size:15px;}
body{background:var(--bg);background-image:radial-gradient(ellipse 65% 45% at 18% 18%,rgba(20,55,120,.6) 0%,transparent 65%),radial-gradient(ellipse 45% 55% at 85% 82%,rgba(90,18,44,.32) 0%,transparent 62%);font-family:'Crimson Pro',serif;color:var(--cloud);min-height:100vh;overflow-x:hidden;}
.screen{display:none;flex-direction:column;align-items:center;min-height:100vh;}.screen.on{display:flex;}
#s-lobby{justify-content:center;gap:20px;padding:28px 18px;}
.logo{font-family:'Playfair Display',serif;font-size:clamp(2.4rem,9vw,4.4rem);font-weight:900;color:var(--gold2);letter-spacing:.1em;text-align:center;text-shadow:0 0 36px rgba(200,144,58,.45);}
.logo-sub{font-size:.78rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(221,213,192,.35);text-align:center;margin-top:-18px;}
.choices{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;}
.choice{background:var(--panel);border:1px solid rgba(180,148,58,.18);border-radius:14px;padding:22px 26px;width:210px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:all .2s;text-align:center;}
.choice:hover{border-color:var(--gold);transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.4);}
.ch-icon{font-size:2.4rem;}.ch-title{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold2);}.ch-desc{font-size:.82rem;color:rgba(221,213,192,.48);line-height:1.5;}
.or-div{display:flex;align-items:center;gap:10px;width:100%;max-width:440px;color:rgba(221,213,192,.26);font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;}
.or-div::before,.or-div::after{content:'';flex:1;height:1px;background:rgba(180,148,58,.12);}
.field{padding:10px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(180,148,58,.28);border-radius:8px;color:var(--cloud);font-family:'Crimson Pro',serif;font-size:1rem;outline:none;width:100%;max-width:260px;text-align:center;transition:border-color .2s;}
.field:focus{border-color:var(--gold);}.field::placeholder{color:rgba(221,213,192,.26);}
.code-field{text-transform:uppercase;letter-spacing:.22em;font-size:1.1rem;}
.join-box{display:none;flex-direction:column;align-items:center;gap:9px;width:100%;max-width:280px;}.join-box.open{display:flex;}
/* WAIT */
#s-wait{justify-content:flex-start;padding:22px 14px 28px;gap:16px;align-items:center;}
.wait-h{font-family:'Playfair Display',serif;font-size:1.75rem;color:var(--gold2);letter-spacing:.06em;text-align:center;}
.wait-layout{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;width:100%;max-width:740px;}
.wpanel{background:var(--panel);border:1px solid rgba(180,148,58,.18);border-radius:14px;padding:20px;}
.wpanel h3{font-family:'Playfair Display',serif;font-size:.95rem;color:var(--gold);margin-bottom:10px;letter-spacing:.07em;}
#qr-wrap{background:#fff;padding:9px;border-radius:8px;display:inline-block;}
#qr-wrap canvas,#qr-wrap img{display:block;}
.rcode-lbl{font-size:.66rem;text-transform:uppercase;letter-spacing:.12em;color:rgba(221,213,192,.35);margin-top:8px;text-align:center;}
.rcode{font-family:'Playfair Display',serif;font-size:2rem;letter-spacing:.32em;color:var(--gold2);text-align:center;}
#plist{display:flex;flex-direction:column;gap:6px;min-width:190px;}
.prow{display:flex;align-items:center;gap:8px;padding:7px 10px;background:rgba(255,255,255,.04);border-radius:7px;border:1px solid rgba(255,255,255,.05);font-size:.9rem;}
.prow.me{border-color:rgba(180,148,58,.28);}
.pav{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.pname{flex:1;}.pbadge{font-size:.6rem;letter-spacing:.07em;text-transform:uppercase;color:var(--gold);padding:2px 5px;border:1px solid rgba(180,148,58,.28);border-radius:3px;}
/* CONN */
#s-conn{justify-content:center;gap:16px;padding:30px;text-align:center;}
#s-conn h2{font-family:'Playfair Display',serif;font-size:1.9rem;color:var(--gold2);}
.conn-msg{font-size:.95rem;color:rgba(221,213,192,.6);max-width:300px;line-height:1.6;}
.pulse{animation:pulse 1.4s ease-in-out infinite;}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
/* GAME */
#s-game{justify-content:flex-start;padding:0;}
#topbar{width:100%;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;padding:6px 12px;background:rgba(6,14,28,.8);border-bottom:1px solid rgba(180,148,58,.12);}
.tb{display:flex;flex-direction:column;align-items:center;}.tb-l{font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(221,213,192,.32);}.tb-v{font-size:.88rem;color:var(--gold2);font-weight:600;}
#msgbar{width:100%;text-align:center;padding:7px 10px;min-height:34px;font-size:.9rem;color:var(--gold2);background:rgba(180,148,58,.06);border-bottom:1px solid rgba(180,148,58,.08);}
#strip{width:100%;overflow-x:auto;display:flex;gap:7px;padding:6px 10px;background:rgba(4,11,22,.65);border-bottom:1px solid rgba(180,148,58,.07);}
.sp{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:2px;padding:3px 6px;border-radius:5px;}
.sp.cur{background:rgba(180,148,58,.14);outline:1px solid rgba(180,148,58,.33);}.sp.me{outline:1px solid rgba(80,180,80,.33);}
.sp-av{font-size:1.15rem;}.sp-nm{font-size:.6rem;color:rgba(221,213,192,.52);max-width:54px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.sp-sc{font-size:.62rem;color:var(--gold2);font-weight:600;}
#gcontent{width:100%;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px 10px 24px;}
#opps{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;width:100%;}
.opp{display:flex;flex-direction:column;align-items:center;gap:3px;}
.opp-nm{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(221,213,192,.42);}.opp-nm.cur{color:var(--gold2);}
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;}
.mc{width:28px;height:44px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-family:'Playfair Display',serif;font-weight:700;border:1px solid transparent;user-select:none;}
.mc.bk{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.15);font-size:.72rem;}.mc.el{opacity:.28;text-decoration:line-through;}
#piles{display:flex;gap:14px;align-items:flex-end;justify-content:center;flex-wrap:wrap;}
.pg{display:flex;flex-direction:column;align-items:center;gap:3px;}
.plbl{font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(221,213,192,.32);}
.pc{width:56px;height:84px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.38rem;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s;user-select:none;border:2px solid transparent;}
.pc:hover:not(.off){transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,.5);}.pc.off{pointer-events:none;opacity:.36;}
.pc.bk{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.17);background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px),repeating-linear-gradient(-45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px);}
.pc.mt{background:rgba(255,255,255,.03);border:2px dashed rgba(180,148,58,.19);color:rgba(221,213,192,.14);}
#held-viz{width:56px;height:84px;border-radius:7px;display:none !important;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.38rem;font-weight:700;border:2px solid var(--gold2);box-shadow:0 0 14px rgba(200,144,58,.36);}
#mzone{display:flex;flex-direction:column;align-items:center;gap:5px;}
.mzone-lbl{font-family:'Playfair Display',serif;font-size:.85rem;color:var(--gold);letter-spacing:.1em;text-transform:uppercase;}
.mgrid2{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
.mycard{width:56px;height:84px;border-radius:7px;cursor:pointer;transition:transform .15s,box-shadow .15s;}
@media(min-width:420px){.mycard{width:66px;height:98px;}}
.mycard:hover:not(.na){transform:translateY(-4px);box-shadow:0 6px 15px rgba(0,0,0,.5);}.mycard.na{cursor:default;}
.mcf{width:100%;height:100%;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.35rem;font-weight:700;border:2px solid transparent;user-select:none;}
.mycard.bk .mcf{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.14);font-size:1.05rem;background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px),repeating-linear-gradient(-45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px);}
.mycard.el .mcf{opacity:.28;text-decoration:line-through;}
.my-vs{font-size:.75rem;color:rgba(221,213,192,.4);}.my-vs span{color:var(--gold2);font-weight:600;}
#btn-dh{font-family:'Crimson Pro',serif;font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;padding:7px 15px;border-radius:6px;cursor:pointer;border:1px solid var(--gold);background:transparent;color:var(--gold);display:none;transition:background .15s;}
#btn-dh:hover{background:rgba(200,144,58,.1);}
/* END */
#ov-end{display:none;position:fixed;inset:0;z-index:300;background:rgba(3,8,18,.93);align-items:center;justify-content:center;}#ov-end.on{display:flex;}
#mod-end{background:linear-gradient(145deg,#0b1e46,#182f66);border:1px solid var(--gold);border-radius:14px;padding:28px 36px;max-width:420px;width:92%;text-align:center;box-shadow:0 0 54px rgba(200,144,58,.17);}
#mod-end h2{font-family:'Playfair Display',serif;font-size:1.75rem;color:var(--gold2);margin-bottom:9px;}
.esub{font-size:.95rem;color:var(--cloud);margin-bottom:14px;line-height:1.5;}
.etbl{width:100%;border-collapse:collapse;margin:5px 0;}.etbl th{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(221,213,192,.35);padding:3px 7px;}
.etbl td{padding:6px 7px;border-bottom:1px solid rgba(255,255,255,.04);font-size:.9rem;}.etbl tr:last-child td{border:none;}
.ew{color:var(--gold2);font-weight:600;}.ep{color:var(--gold);font-weight:600;}
.btn-p,.btn-s{font-family:'Crimson Pro',serif;font-size:.93rem;letter-spacing:.08em;text-transform:uppercase;padding:9px 21px;border-radius:7px;cursor:pointer;transition:all .17s;border:1px solid var(--gold);}
.btn-p{background:var(--gold);color:#081408;font-weight:600;}.btn-p:hover{background:var(--gold2);transform:translateY(-2px);box-shadow:0 4px 12px rgba(200,144,58,.36);}
.btn-s{background:transparent;color:var(--gold);}.btn-s:hover{background:rgba(200,144,58,.09);transform:translateY(-2px);}
button:disabled{opacity:.3!important;cursor:not-allowed!important;pointer-events:none;}
.btn-row{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;}
#toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#222;color:var(--gold2);border:1px solid var(--gold);padding:10px 20px;border-radius:8px;font-size:.88rem;display:none;z-index:500;max-width:90%;text-align:center;}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="s-lobby" class="screen on">
  <div class="logo">âœˆ SKY JOE</div>
  <div class="logo-sub">Le jeu des nuages et des cartes</div>
  <input class="field" id="inp-name" type="text" maxlength="16" placeholder="Votre prÃ©nomâ€¦"/>
  <div class="choices">
    <div class="choice" onclick="doHost()">
      <div class="ch-icon">ðŸŽ²</div>
      <div class="ch-title">CrÃ©er une partie</div>
      <div class="ch-desc">GÃ©nÃ©rez un QR code et invitez vos amis</div>
    </div>
    <div class="choice" onclick="openJoin()">
      <div class="ch-icon">ðŸ“±</div>
      <div class="ch-title">Rejoindre</div>
      <div class="ch-desc">Scannez le QR code ou entrez le code Ã  6 lettres</div>
    </div>
  </div>
  <div class="or-div">ou entrez le code manuellement</div>
  <div class="join-box" id="join-box">
    <input class="field code-field" id="inp-code" type="text" maxlength="6" placeholder="XXXXXX"/>
    <div class="btn-row">
      <button class="btn-p" onclick="doJoin()">Rejoindre â†’</button>
      <button class="btn-s" onclick="closeJoin()">Annuler</button>
    </div>
  </div>
</div>

<!-- CONNEXION EN COURS -->
<div id="s-conn" class="screen">
  <h2>âœˆ Sky Joe</h2>
  <div class="conn-msg pulse" id="conn-msg">Initialisationâ€¦</div>
  <button class="btn-s" onclick="goLobby()" style="margin-top:12px">Annuler</button>
</div>

<!-- SALLE D'ATTENTE -->
<div id="s-wait" class="screen">
  <div class="wait-h">âœˆ Salle d'attente</div>
  <div class="wait-layout">
    <div class="wpanel" style="display:flex;flex-direction:column;align-items:center;gap:9px;">
      <h3>ðŸ“± Scanner pour rejoindre</h3>
      <div id="qr-wrap"></div>
      <div class="rcode-lbl">Code de la salle</div>
      <div class="rcode" id="rcode-txt">â€”â€”</div>
    </div>
    <div class="wpanel">
      <h3>Joueurs</h3>
      <div id="plist"></div>
      <div style="margin-top:10px;font-size:.8rem;color:rgba(221,213,192,.38);" id="wait-info">En attenteâ€¦</div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-p" id="btn-start" onclick="hostStart()" disabled>Lancer</button>
        <button class="btn-s" onclick="goLobby()">Quitter</button>
      </div>
    </div>
  </div>
</div>

<!-- JEU -->
<div id="s-game" class="screen">
  <div id="topbar">
    <div class="tb"><span class="tb-l">Manche</span><span class="tb-v" id="tb-r">1</span></div>
    <div class="tb"><span class="tb-l">Phase</span><span class="tb-v" id="tb-p">â€”</span></div>
    <div class="tb"><span class="tb-l">Pioche</span><span class="tb-v" id="tb-d">â€”</span></div>
  </div>
  <div id="msgbar">â€”</div>
  <div id="strip"></div>
  <div id="gcontent">
    <div id="opps"></div>
    <div id="piles">
      <div class="pg"><div class="plbl">En main</div><div id="held-viz"></div></div>
      <div class="pg"><div class="plbl">Pioche</div><div class="pc bk" id="p-deck">âœˆ</div></div>
      <div class="pg"><div class="plbl">DÃ©fausse</div><div class="pc mt" id="p-disc">â€”</div></div>
    </div>
    <button id="btn-dh" onclick="act({type:'discard_held'})">DÃ©fausser la carte en main</button>
    <div id="mzone">
      <div class="mzone-lbl" id="mzone-lbl">Ma grille</div>
      <div class="mgrid2" id="my-grid"></div>
      <div class="my-vs">Score visible : <span id="my-vs">0</span></div>
    </div>
  </div>
</div>

<!-- FIN MANCHE -->
<div id="ov-end">
  <div id="mod-end">
    <h2 id="end-title">Fin de manche</h2>
    <div class="esub" id="end-sub"></div>
    <table class="etbl"><thead><tr><th>Joueur</th><th>Manche</th><th>Total</th></tr></thead><tbody id="end-body"></tbody></table>
    <div class="btn-row" style="margin-top:16px;" id="end-btns"></div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';

/* ===============================
   Ã‰TAT GLOBAL
=================================*/

let peer=null,myId=null,myName='',roomCode='',isHost=false;
let hostConn=null;
let clientConns={};
let localHeld=null;

let G={
  players:[],
  deck:[],
  discard:[],
  phase:'lobby',
  currentTurn:0,
  finalRound:false,
  finalBy:null,
  round:1,
  initCounts:{},
  seq:0              // ðŸ”¥ numÃ©ro de sÃ©quence global
};

let lastSeq=0;       // ðŸ”¥ cÃ´tÃ© client

/* ===============================
   OUTILS
=================================*/

function shuffle(a){
  const r=[...a];
  for(let i=r.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [r[i],r[j]]=[r[j],r[i]];
  }
  return r;
}

function buildDeck(){
  const d=[];
  for(let i=0;i<5;i++)d.push(-2);
  for(let i=0;i<10;i++)d.push(-1);
  for(let i=0;i<15;i++)d.push(0);
  for(let v=1;v<=12;v++)
    for(let i=0;i<10;i++)d.push(v);
  return shuffle(d);
}

/* ===============================
   SYNCHRONISATION DÃ‰TERMINISTE
=================================*/

function syncAll(extra={}){

  const payload={
    type:'sync',
    seq:++G.seq,
    state:serializeState(),
    ...extra
  };

  // envoyer aux clients
  Object.values(clientConns).forEach(c=>{
    if(c&&c.open)c.send(payload);
  });

  // appliquer localement (hÃ´te)
  applySync(payload);
}

function serializeState(){
  return{
    phase:G.phase,
    currentTurn:G.currentTurn,
    deck:G.deck,
    discard:G.discard,
    round:G.round,
    finalRound:G.finalRound,
    finalBy:G.finalBy,
    initCounts:G.initCounts,
    players:G.players,
    held:currentHeldMap()
  };
}

function currentHeldMap(){
  const map={};
  G.players.forEach(p=>{
    if(p.held!==undefined)map[p.id]=p.held;
  });
  return map;
}

function applySync(data){

  if(!isHost){
    if(data.seq<=lastSeq)return;   // ðŸ”¥ ignore vieux messages
    lastSeq=data.seq;
  }

  const s=data.state;

  G.phase=s.phase;
  G.currentTurn=s.currentTurn;
  G.deck=s.deck;
  G.discard=s.discard;
  G.round=s.round;
  G.finalRound=s.finalRound;
  G.finalBy=s.finalBy;
  G.initCounts=s.initCounts;
  G.players=s.players;

  localHeld=s.held[myId]??null;

  renderGame();
}

/* ===============================
   ACTIONS HÃ”TE
=================================*/

function processAction(pid,action){

  const player=G.players.find(p=>p.id===pid);
  if(!player)return;

  if(G.phase==='draw'&&action.type==='draw_deck'){
    if(G.deck.length===0)return;
    player.held=G.deck.pop();
    G.phase='place';
    syncAll();
    return;
  }

  if(G.phase==='draw'&&action.type==='draw_discard'){
    if(G.discard.length===0)return;
    player.held=G.discard.pop();
    G.phase='place';
    syncAll();
    return;
  }

  if(G.phase==='place'&&action.type==='place_card'){
    const old=player.cards[action.idx].val;
    player.cards[action.idx]={val:player.held,revealed:true,elim:false};
    G.discard.push(old);
    delete player.held;
    G.phase='draw';
    G.currentTurn=(G.currentTurn+1)%G.players.length;
    syncAll();
    return;
  }

  if(G.phase==='place'&&action.type==='discard_held'){
    G.discard.push(player.held);
    delete player.held;
    G.phase='draw';
    G.currentTurn=(G.currentTurn+1)%G.players.length;
    syncAll();
    return;
  }
}

/* ===============================
   CLIENT MESSAGES
=================================*/

function handleClientMsg(data){

  if(data.type==='sync'){
    applySync(data);
  }

}

/* ===============================
   RENDU CARTE EN MAIN
=================================*/

function renderGame(){

  const hv=document.getElementById('held-viz');

  if(G.phase==='place'&&localHeld!=null){
    hv.style.display='flex';
    hv.textContent=localHeld>0?'+'+localHeld:localHeld;
  }else{
    hv.style.display='none';
  }

}

/* ===============================
   ENVOI ACTION
=================================*/

function act(action){

  if(isHost){
    processAction(myId,action);
  }else if(hostConn&&hostConn.open){
    hostConn.send({type:'action',action});
  }

}
</script>
</body>
</html>
