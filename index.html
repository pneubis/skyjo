<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sky Joe ‚úà</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Crimson+Pro:wght@300;400;600&display=swap');
:root{--bg:#06101c;--gold:#c9903a;--gold2:#f0c85e;--cloud:#ddd5c0;--back:#112255;--back-b:rgba(180,148,58,.38);--panel:rgba(13,30,60,.82);}
*{margin:0;padding:0;box-sizing:border-box;}html{font-size:15px;}
body{background:var(--bg);background-image:radial-gradient(ellipse 65% 45% at 18% 18%,rgba(20,55,120,.6) 0%,transparent 65%),radial-gradient(ellipse 45% 55% at 85% 82%,rgba(90,18,44,.32) 0%,transparent 62%);font-family:'Crimson Pro',serif;color:var(--cloud);min-height:100vh;overflow-x:hidden;}
.screen{display:none;flex-direction:column;align-items:center;min-height:100vh;}.screen.on{display:flex;}
#s-lobby{justify-content:center;gap:20px;padding:28px 18px;}
.logo{font-family:'Playfair Display',serif;font-size:clamp(2.4rem,9vw,4.4rem);font-weight:900;color:var(--gold2);letter-spacing:.1em;text-align:center;text-shadow:0 0 36px rgba(200,144,58,.45);}
.logo-sub{font-size:.78rem;letter-spacing:.2em;text-transform:uppercase;color:rgba(221,213,192,.35);text-align:center;margin-top:-18px;}
.choices{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;}
.choice{background:var(--panel);border:1px solid rgba(180,148,58,.18);border-radius:14px;padding:22px 26px;width:210px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:all .2s;text-align:center;}
.choice:hover{border-color:var(--gold);transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.4);}
.ch-icon{font-size:2.4rem;}.ch-title{font-family:'Playfair Display',serif;font-size:1.15rem;color:var(--gold2);}.ch-desc{font-size:.82rem;color:rgba(221,213,192,.48);line-height:1.5;}
.or-div{display:flex;align-items:center;gap:10px;width:100%;max-width:440px;color:rgba(221,213,192,.26);font-size:.72rem;letter-spacing:.12em;text-transform:uppercase;}
.or-div::before,.or-div::after{content:'';flex:1;height:1px;background:rgba(180,148,58,.12);}
.field{padding:10px 16px;background:rgba(255,255,255,.05);border:1px solid rgba(180,148,58,.28);border-radius:8px;color:var(--cloud);font-family:'Crimson Pro',serif;font-size:1rem;outline:none;width:100%;max-width:260px;text-align:center;transition:border-color .2s;}
.field:focus{border-color:var(--gold);}.field::placeholder{color:rgba(221,213,192,.26);}
.code-field{text-transform:uppercase;letter-spacing:.22em;font-size:1.1rem;}
.join-box{display:none;flex-direction:column;align-items:center;gap:9px;width:100%;max-width:280px;}.join-box.open{display:flex;}
/* WAIT */
#s-wait{justify-content:flex-start;padding:22px 14px 28px;gap:16px;align-items:center;}
.wait-h{font-family:'Playfair Display',serif;font-size:1.75rem;color:var(--gold2);letter-spacing:.06em;text-align:center;}
.wait-layout{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;width:100%;max-width:740px;}
.wpanel{background:var(--panel);border:1px solid rgba(180,148,58,.18);border-radius:14px;padding:20px;}
.wpanel h3{font-family:'Playfair Display',serif;font-size:.95rem;color:var(--gold);margin-bottom:10px;letter-spacing:.07em;}
#qr-wrap{background:#fff;padding:9px;border-radius:8px;display:inline-block;}
#qr-wrap canvas,#qr-wrap img{display:block;}
.rcode-lbl{font-size:.66rem;text-transform:uppercase;letter-spacing:.12em;color:rgba(221,213,192,.35);margin-top:8px;text-align:center;}
.rcode{font-family:'Playfair Display',serif;font-size:2rem;letter-spacing:.32em;color:var(--gold2);text-align:center;}
#plist{display:flex;flex-direction:column;gap:6px;min-width:190px;}
.prow{display:flex;align-items:center;gap:8px;padding:7px 10px;background:rgba(255,255,255,.04);border-radius:7px;border:1px solid rgba(255,255,255,.05);font-size:.9rem;}
.prow.me{border-color:rgba(180,148,58,.28);}
.pav{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.pname{flex:1;}.pbadge{font-size:.6rem;letter-spacing:.07em;text-transform:uppercase;color:var(--gold);padding:2px 5px;border:1px solid rgba(180,148,58,.28);border-radius:3px;}
/* CONN */
#s-conn{justify-content:center;gap:16px;padding:30px;text-align:center;}
#s-conn h2{font-family:'Playfair Display',serif;font-size:1.9rem;color:var(--gold2);}
.conn-msg{font-size:.95rem;color:rgba(221,213,192,.6);max-width:300px;line-height:1.6;}
.pulse{animation:pulse 1.4s ease-in-out infinite;}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
/* GAME */
#s-game{justify-content:flex-start;padding:0;}
#topbar{width:100%;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px;padding:6px 12px;background:rgba(6,14,28,.8);border-bottom:1px solid rgba(180,148,58,.12);}
.tb{display:flex;flex-direction:column;align-items:center;}.tb-l{font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(221,213,192,.32);}.tb-v{font-size:.88rem;color:var(--gold2);font-weight:600;}
#msgbar{width:100%;text-align:center;padding:7px 10px;min-height:34px;font-size:.9rem;color:var(--gold2);background:rgba(180,148,58,.06);border-bottom:1px solid rgba(180,148,58,.08);}
#strip{width:100%;overflow-x:auto;display:flex;gap:7px;padding:6px 10px;background:rgba(4,11,22,.65);border-bottom:1px solid rgba(180,148,58,.07);}
.sp{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:2px;padding:3px 6px;border-radius:5px;}
.sp.cur{background:rgba(180,148,58,.14);outline:1px solid rgba(180,148,58,.33);}.sp.me{outline:1px solid rgba(80,180,80,.33);}
.sp-av{font-size:1.15rem;}.sp-nm{font-size:.6rem;color:rgba(221,213,192,.52);max-width:54px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.sp-sc{font-size:.62rem;color:var(--gold2);font-weight:600;}
#gcontent{width:100%;display:flex;flex-direction:column;align-items:center;gap:10px;padding:10px 10px 24px;}
#opps{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;width:100%;}
.opp{display:flex;flex-direction:column;align-items:center;gap:3px;}
.opp-nm{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(221,213,192,.42);}.opp-nm.cur{color:var(--gold2);}
.mgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;}
.mc{width:28px;height:44px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-family:'Playfair Display',serif;font-weight:700;border:1px solid transparent;user-select:none;}
.mc.bk{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.15);font-size:.72rem;}.mc.el{opacity:.28;text-decoration:line-through;}
#piles{display:flex;gap:14px;align-items:flex-end;justify-content:center;flex-wrap:wrap;}
.pg{display:flex;flex-direction:column;align-items:center;gap:3px;}
.plbl{font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:rgba(221,213,192,.32);}
.pc{width:56px;height:84px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.38rem;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s;user-select:none;border:2px solid transparent;}
.pc:hover:not(.off){transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,.5);}.pc.off{pointer-events:none;opacity:.36;}
.pc.bk{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.17);background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px),repeating-linear-gradient(-45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px);}
.pc.mt{background:rgba(255,255,255,.03);border:2px dashed rgba(180,148,58,.19);color:rgba(221,213,192,.14);}
#held-viz{width:56px;height:84px;border-radius:7px;display:none;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.38rem;font-weight:700;border:2px solid var(--gold2);box-shadow:0 0 14px rgba(200,144,58,.36);}
#mzone{display:flex;flex-direction:column;align-items:center;gap:5px;}
.mzone-lbl{font-family:'Playfair Display',serif;font-size:.85rem;color:var(--gold);letter-spacing:.1em;text-transform:uppercase;}
.mgrid2{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;}
.mycard{width:56px;height:84px;border-radius:7px;cursor:pointer;transition:transform .15s,box-shadow .15s;}
@media(min-width:420px){.mycard{width:66px;height:98px;}}
.mycard:hover:not(.na){transform:translateY(-4px);box-shadow:0 6px 15px rgba(0,0,0,.5);}.mycard.na{cursor:default;}
.mcf{width:100%;height:100%;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Playfair Display',serif;font-size:1.35rem;font-weight:700;border:2px solid transparent;user-select:none;}
.mycard.bk .mcf{background:var(--back);border-color:var(--back-b);color:rgba(180,148,58,.14);font-size:1.05rem;background-image:repeating-linear-gradient(45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px),repeating-linear-gradient(-45deg,rgba(255,255,255,.02) 0,rgba(255,255,255,.02) 1px,transparent 1px,transparent 8px);}
.mycard.el .mcf{opacity:.28;text-decoration:line-through;}
.my-vs{font-size:.75rem;color:rgba(221,213,192,.4);}.my-vs span{color:var(--gold2);font-weight:600;}
#btn-dh{font-family:'Crimson Pro',serif;font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;padding:7px 15px;border-radius:6px;cursor:pointer;border:1px solid var(--gold);background:transparent;color:var(--gold);display:none;transition:background .15s;}
#btn-dh:hover{background:rgba(200,144,58,.1);}
/* END */
#ov-end{display:none;position:fixed;inset:0;z-index:300;background:rgba(3,8,18,.93);align-items:center;justify-content:center;}#ov-end.on{display:flex;}
#mod-end{background:linear-gradient(145deg,#0b1e46,#182f66);border:1px solid var(--gold);border-radius:14px;padding:28px 36px;max-width:420px;width:92%;text-align:center;box-shadow:0 0 54px rgba(200,144,58,.17);}
#mod-end h2{font-family:'Playfair Display',serif;font-size:1.75rem;color:var(--gold2);margin-bottom:9px;}
.esub{font-size:.95rem;color:var(--cloud);margin-bottom:14px;line-height:1.5;}
.etbl{width:100%;border-collapse:collapse;margin:5px 0;}.etbl th{font-size:.65rem;text-transform:uppercase;letter-spacing:.08em;color:rgba(221,213,192,.35);padding:3px 7px;}
.etbl td{padding:6px 7px;border-bottom:1px solid rgba(255,255,255,.04);font-size:.9rem;}.etbl tr:last-child td{border:none;}
.ew{color:var(--gold2);font-weight:600;}.ep{color:var(--gold);font-weight:600;}
.btn-p,.btn-s{font-family:'Crimson Pro',serif;font-size:.93rem;letter-spacing:.08em;text-transform:uppercase;padding:9px 21px;border-radius:7px;cursor:pointer;transition:all .17s;border:1px solid var(--gold);}
.btn-p{background:var(--gold);color:#081408;font-weight:600;}.btn-p:hover{background:var(--gold2);transform:translateY(-2px);box-shadow:0 4px 12px rgba(200,144,58,.36);}
.btn-s{background:transparent;color:var(--gold);}.btn-s:hover{background:rgba(200,144,58,.09);transform:translateY(-2px);}
button:disabled{opacity:.3!important;cursor:not-allowed!important;pointer-events:none;}
.btn-row{display:flex;gap:9px;flex-wrap:wrap;justify-content:center;}
#toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#222;color:var(--gold2);border:1px solid var(--gold);padding:10px 20px;border-radius:8px;font-size:.88rem;display:none;z-index:500;max-width:90%;text-align:center;}
</style>
</head>
<body>

<!-- LOBBY -->
<div id="s-lobby" class="screen on">
  <div class="logo">‚úà SKY JOE</div>
  <div class="logo-sub">Le jeu des nuages et des cartes</div>
  <input class="field" id="inp-name" type="text" maxlength="16" placeholder="Votre pr√©nom‚Ä¶"/>
  <div class="choices">
    <div class="choice" onclick="doHost()">
      <div class="ch-icon">üé≤</div>
      <div class="ch-title">Cr√©er une partie</div>
      <div class="ch-desc">G√©n√©rez un QR code et invitez vos amis</div>
    </div>
    <div class="choice" onclick="openJoin()">
      <div class="ch-icon">üì±</div>
      <div class="ch-title">Rejoindre</div>
      <div class="ch-desc">Scannez le QR code ou entrez le code √† 6 lettres</div>
    </div>
  </div>
  <div class="or-div">ou entrez le code manuellement</div>
  <div class="join-box" id="join-box">
    <input class="field code-field" id="inp-code" type="text" maxlength="6" placeholder="XXXXXX"/>
    <div class="btn-row">
      <button class="btn-p" onclick="doJoin()">Rejoindre ‚Üí</button>
      <button class="btn-s" onclick="closeJoin()">Annuler</button>
    </div>
  </div>
</div>

<!-- CONNEXION EN COURS -->
<div id="s-conn" class="screen">
  <h2>‚úà Sky Joe</h2>
  <div class="conn-msg pulse" id="conn-msg">Initialisation‚Ä¶</div>
  <button class="btn-s" onclick="goLobby()" style="margin-top:12px">Annuler</button>
</div>

<!-- SALLE D'ATTENTE -->
<div id="s-wait" class="screen">
  <div class="wait-h">‚úà Salle d'attente</div>
  <div class="wait-layout">
    <div class="wpanel" style="display:flex;flex-direction:column;align-items:center;gap:9px;">
      <h3>üì± Scanner pour rejoindre</h3>
      <div id="qr-wrap"></div>
      <div class="rcode-lbl">Code de la salle</div>
      <div class="rcode" id="rcode-txt">‚Äî‚Äî</div>
    </div>
    <div class="wpanel">
      <h3>Joueurs</h3>
      <div id="plist"></div>
      <div style="margin-top:10px;font-size:.8rem;color:rgba(221,213,192,.38);" id="wait-info">En attente‚Ä¶</div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="btn-p" id="btn-start" onclick="hostStart()" disabled>Lancer</button>
        <button class="btn-s" onclick="goLobby()">Quitter</button>
      </div>
    </div>
  </div>
</div>

<!-- JEU -->
<div id="s-game" class="screen">
  <div id="topbar">
    <div class="tb"><span class="tb-l">Manche</span><span class="tb-v" id="tb-r">1</span></div>
    <div class="tb"><span class="tb-l">Phase</span><span class="tb-v" id="tb-p">‚Äî</span></div>
    <div class="tb"><span class="tb-l">Pioche</span><span class="tb-v" id="tb-d">‚Äî</span></div>
  </div>
  <div id="msgbar">‚Äî</div>
  <div id="strip"></div>
  <div id="gcontent">
    <div id="opps"></div>
    <div id="piles">
      <div class="pg"><div class="plbl">En main</div><div id="held-viz"></div></div>
      <div class="pg"><div class="plbl">Pioche</div><div class="pc bk" id="p-deck">‚úà</div></div>
      <div class="pg"><div class="plbl">D√©fausse</div><div class="pc mt" id="p-disc">‚Äî</div></div>
    </div>
    <button id="btn-dh" onclick="act({type:'discard_held'})">D√©fausser la carte en main</button>
    <div id="mzone">
      <div class="mzone-lbl" id="mzone-lbl">Ma grille</div>
      <div class="mgrid2" id="my-grid"></div>
      <div class="my-vs">Score visible : <span id="my-vs">0</span></div>
    </div>
  </div>
</div>

<!-- FIN MANCHE -->
<div id="ov-end">
  <div id="mod-end">
    <h2 id="end-title">Fin de manche</h2>
    <div class="esub" id="end-sub"></div>
    <table class="etbl"><thead><tr><th>Joueur</th><th>Manche</th><th>Total</th></tr></thead><tbody id="end-body"></tbody></table>
    <div class="btn-row" style="margin-top:16px;" id="end-btns"></div>
  </div>
</div>

<div id="toast"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AVATARS = ['ü¶Ö','ü¶â','ü¶ú','ü¶Ü','ü¶©','üê¶','ü¶ã','üåü'];
const PALETTE = ['#e06030','#3080e0','#30a060','#c040a0','#e0a020','#40b0c0','#a060e0','#e05060'];
const PHASE_LBL = {init:'R√©v√©ler 2 cartes',draw:'Piocher',place:'Placer',reveal_discard:'R√©v√©ler',end_round:'Fin',lobby:'Lobby'};
const CC = {'-2':{bg:'#1030a8',col:'#c8d0ff'},'-1':{bg:'#1555a0',col:'#c0d8f0'},'0':{bg:'#c8e8d0',col:'#1a6030'},'1':{bg:'#e0f0c0',col:'#304808'},'2':{bg:'#f8eea0',col:'#605000'},'3':{bg:'#f8dc80',col:'#704000'},'4':{bg:'#f8c860',col:'#7a3800'},'5':{bg:'#f8b048',col:'#802800'},'6':{bg:'#f49830',col:'#7c2000'},'7':{bg:'#ee7c20',col:'#741808'},'8':{bg:'#e45e14',col:'#fff'},'9':{bg:'#d84010',col:'#fff'},'10':{bg:'#c82808',col:'#fff'},'11':{bg:'#a81808',col:'#ffc0b0'},'12':{bg:'#880800',col:'#ffb0a0'}};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clr(el,v){const c=CC[String(v)];if(!c)return;el.style.background=c.bg;el.style.color=c.col;el.style.borderColor='rgba(0,0,0,.2)';}
function fmt(v){return v>0?'+'+v:String(v);}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function $(id){return document.getElementById(id);}
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('on'));$(id).classList.add('on');}
function toast(m,ms=4000){const t=$('toast');t.textContent=m;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',ms);}
function setMsg(m){$('conn-msg').textContent=m;}

function shuffle(a){const r=[...a];for(let i=r.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[r[i],r[j]]=[r[j],r[i]];}return r;}

function buildDeck(){
  const d=[];
  for(let i=0;i<5;i++)d.push(-2);for(let i=0;i<10;i++)d.push(-1);for(let i=0;i<15;i++)d.push(0);
  for(let v=1;v<=12;v++)for(let i=0;i<10;i++)d.push(v);
  return shuffle(d);
}

// G√©n√®re un code √† 6 lettres sans ambigu√Øt√© visuelle
function genCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c='';for(let i=0;i<6;i++)c+=chars[Math.floor(Math.random()*chars.length)];
  return c;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer=null, myId=null, myName='', roomCode='', isHost=false;
let hostConn=null;       // client‚Üíh√¥te
let clientConns={};      // h√¥te‚Üíclients  {peerId: conn}
let localHeld=null;

let G={players:[],deck:[],discard:[],phase:'lobby',currentTurn:0,finalRound:false,finalBy:null,round:1,initCounts:{}};
const heldCards={};  // {playerId: value}  ‚Äî uniquement chez l'h√¥te

function me(){return G.players.find(p=>p.id===myId);}
function curP(){return G.players[G.currentTurn];}
function isMyTurn(){return curP()&&curP().id===myId;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEERJS CONFIG ‚Äî serveur fiable
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// On utilise le serveur PeerJS officiel sur peerjs.com
// L'h√¥te r√©serve un peer ID = "skyjoe-" + code √† 6 lettres
// ‚Üí pr√©visible, court, communicable
function peerConfig(){
  return {
    // Serveur de signalisation public PeerJS (plus fiable que le d√©faut)
    host: '0.peerjs.com',
    port: 443,
    path: '/',
    secure: true,
    debug: 0,
    config: {
      iceServers: [
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'},
        // TURN gratuit fourni par metered.ca (√©vite les √©checs NAT)
        {urls:'turn:a.relay.metered.ca:80',username:'open',credential:'open'},
        {urls:'turn:a.relay.metered.ca:443',username:'open',credential:'open'},
      ]
    }
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goLobby(){
  if(peer){try{peer.destroy();}catch(e){} peer=null;}
  hostConn=null; clientConns={}; localHeld=null; isHost=false; myId=null; roomCode='';
  Object.keys(heldCards).forEach(k=>delete heldCards[k]);
  G={players:[],deck:[],discard:[],phase:'lobby',currentTurn:0,finalRound:false,finalBy:null,round:1,initCounts:{}};
  $('ov-end').classList.remove('on');
  show('s-lobby');
}
function openJoin(){$('join-box').classList.add('open');}
function closeJoin(){$('join-box').classList.remove('open');}
function getName(){return($('inp-name').value.trim()||'Joueur').slice(0,16);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  H√îTE ‚Äî CR√âER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doHost(){
  myName=getName();
  isHost=true;
  roomCode=genCode();
  const hostPeerId='skyjoe-'+roomCode;

  show('s-conn');
  setMsg('Connexion au r√©seau‚Ä¶');

  peer=new Peer(hostPeerId, peerConfig());

  peer.on('open', id=>{
    myId=id;
    // S'inscrire en tant que joueur 0
    G.players=[{id:myId,name:myName,avatar:AVATARS[0],color:PALETTE[0],cards:[],total:0,connected:true}];
    G.initCounts={};
    // Accepter les connexions entrantes
    peer.on('connection', conn=>{
      conn.on('open',()=>{
        clientConns[conn.peer]=conn;
        conn.on('data', data=>handleHostMsg(conn.peer, data));
        conn.on('close', ()=>onClientDrop(conn.peer));
        conn.on('error', ()=>onClientDrop(conn.peer));
      });
    });
    showWaitRoom();
  });

  peer.on('error', e=>{
    // Si l'ID est d√©j√† pris (salle existante), g√©n√©rer un nouveau code
    if(e.type==='unavailable-id'){
      toast('Code d√©j√† utilis√©, g√©n√©ration d\'un nouveau‚Ä¶');
      peer.destroy();
      peer=null;
      roomCode=genCode();
      doHostWithCode(roomCode);
      return;
    }
    setMsg('Erreur r√©seau : '+e.type+'\nV√©rifiez votre connexion internet.');
    toast('Erreur : '+e.type);
  });
}

function doHostWithCode(code){
  roomCode=code;
  const hostPeerId='skyjoe-'+code;
  peer=new Peer(hostPeerId, peerConfig());
  peer.on('open', id=>{ myId=id; G.players[0].id=myId; showWaitRoom(); });
  peer.on('connection', conn=>{
    conn.on('open',()=>{ clientConns[conn.peer]=conn; conn.on('data',data=>handleHostMsg(conn.peer,data)); conn.on('close',()=>onClientDrop(conn.peer)); conn.on('error',()=>onClientDrop(conn.peer)); });
  });
  peer.on('error', e=>{ toast('Erreur : '+e.type); setMsg('Erreur : '+e.type); });
}

function showWaitRoom(){
  show('s-wait');
  $('rcode-txt').textContent=roomCode;
  // QR code = URL + ?join=CODE
  const url=location.href.split('?')[0]+'?join='+roomCode;
  $('qr-wrap').innerHTML='';
  new QRCode($('qr-wrap'),{text:url,width:180,height:180,colorDark:'#000',colorLight:'#fff',correctLevel:QRCode.CorrectLevel.M});
  renderWaitList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  H√îTE ‚Äî MESSAGES ENTRANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleHostMsg(fromId, data){
  if(data.type==='join_req'){
    if(G.phase!=='lobby'){ sendTo(fromId,{type:'err',msg:'Partie d√©j√† en cours'}); return; }
    const idx=G.players.length;
    G.players.push({id:fromId,name:(data.name||'Joueur').slice(0,16),avatar:AVATARS[idx%AVATARS.length],color:PALETTE[idx%PALETTE.length],cards:[],total:0,connected:true});
    G.initCounts[fromId]=0;
    sendTo(fromId,{type:'welcome',playerId:fromId,roomState:roomState()});
    bcastAll({type:'room_upd',roomState:roomState()});
    renderWaitList();
  }
  if(data.type==='action' && G.phase!=='lobby'){
    processAction(fromId, data.action);
  }
  if(data.type==='next_round'){ hostNewRound(false); }
  if(data.type==='restart'){ hostNewRound(true); }
}

function onClientDrop(id){
  delete clientConns[id];
  const p=G.players.find(p=>p.id===id);
  if(p) p.connected=false;
  if(G.phase!=='lobby') bcastAll({type:'room_upd',roomState:roomState()});
  renderWaitList();
}

function hostStart(){
  if(G.players.length<2){toast('Il faut au moins 2 joueurs !');return;}
  hostNewRound(true);
}

function hostNewRound(isFirst){
  const deck=buildDeck();
  G.deck=deck; G.discard=[G.deck.pop()];
  G.phase='init'; G.currentTurn=0;
  G.finalRound=false; G.finalBy=null; G.initCounts={};
  Object.keys(heldCards).forEach(k=>delete heldCards[k]);
  if(isFirst){ G.round=1; G.players.forEach(p=>p.total=0); }
  else G.round=(G.round||1)+1;
  G.players.forEach(p=>{
    p.cards=G.deck.splice(0,12).map(v=>({val:v,revealed:false,elim:false}));
    p.connected=p.connected!==false;
    G.initCounts[p.id]=0;
  });
  localHeld=null;
  // Distribuer cartes √† chaque joueur + √©tat global
  bcastAll({type:'game_start',roomState:roomState(),cards:cardsFor()});
  // Appliquer localement
  applyRoomState(roomState());
  applyCards(cardsFor());
  $('ov-end').classList.remove('on');
  show('s-game');
  renderGame();
}

function renderWaitList(){
  const list=$('plist'); list.innerHTML='';
  G.players.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='prow'+(p.id===myId?' me':'');
    d.innerHTML=`<div class="pav" style="background:${p.color}22;border:1px solid ${p.color}55">${p.avatar}</div>`+
      `<span class="pname">${esc(p.name)}${p.id===myId?' (vous)':''}</span>`+
      (i===0?'<span class="pbadge">H√¥te</span>':'')+
      `<span style="font-size:.7rem">${p.connected===false?'üî¥':'üü¢'}</span>`;
    list.appendChild(d);
  });
  const btn=$('btn-start');
  if(isHost){
    btn.style.display='';
    btn.disabled=G.players.length<2;
    btn.textContent=G.players.length<2?'En attente (min. 2)':'Lancer ('+G.players.length+' joueurs)';
  } else { btn.style.display='none'; }
  $('wait-info').textContent=isHost?'Partagez le code ou QR ci-dessus':'En attente du lancement par l\'h√¥te‚Ä¶';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLIENT ‚Äî REJOINDRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doJoin(){
  const code=($('inp-code').value.trim().toUpperCase()).replace(/[^A-Z0-9]/g,'');
  if(code.length!==6){toast('Le code doit faire 6 caract√®res');return;}
  joinWithCode(code);
}

function joinWithCode(code){
  myName=getName();
  isHost=false;
  show('s-conn');
  setMsg('Connexion au r√©seau‚Ä¶');

  peer=new Peer(peerConfig());  // ID al√©atoire pour le client

  peer.on('open', id=>{
    myId=id;
    setMsg('Connexion √† la salle '+code+'‚Ä¶');
    const hostPeerId='skyjoe-'+code;
    const conn=peer.connect(hostPeerId,{reliable:true,serialization:'json'});
    hostConn=conn;

    let opened=false;
    const timeout=setTimeout(()=>{
      if(!opened){
        toast('Impossible de rejoindre. V√©rifiez le code ou attendez que l\'h√¥te soit connect√©.');
        setMsg('Salle introuvable. V√©rifiez le code.');
      }
    },8000);

    conn.on('open',()=>{
      opened=true;
      clearTimeout(timeout);
      setMsg('Connect√© ! En attente‚Ä¶');
      conn.send({type:'join_req',name:myName});
    });
    conn.on('data', data=>handleClientMsg(data));
    conn.on('error', e=>{ clearTimeout(timeout); toast('Erreur connexion : '+e.type); setMsg('Erreur : '+e.type); });
    conn.on('close', ()=>{ if(G.phase!=='lobby') toast('Connexion √† l\'h√¥te perdue.',5000); });
  });

  peer.on('error', e=>{
    toast('Erreur r√©seau : '+e.type);
    setMsg('Erreur r√©seau : '+e.type);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CLIENT ‚Äî MESSAGES ENTRANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleClientMsg(data){
  if(data.type==='welcome'){
    myId=data.playerId;
    applyRoomState(data.roomState);
    show('s-wait');
    renderWaitList();
  }
  if(data.type==='room_upd'){
    applyRoomState(data.roomState);
    if(G.phase==='lobby') renderWaitList();
    else renderGame();
  }
  if(data.type==='game_start'){
    applyRoomState(data.roomState);
    applyCards(data.cards);
    localHeld=null;
    $('ov-end').classList.remove('on');
    show('s-game');
    renderGame();
  }
  if(data.type==='state_upd'){
    applyRoomState(data.roomState);
    if(data.cards) applyCards(data.cards);
    renderGame();
  }
  if(data.type==='held'){ localHeld=data.val; renderGame(); }
  if(data.type==='clear_held'){ localHeld=null; renderGame(); }
  if(data.type==='end_round'){
    applyRoomState(data.roomState);
    applyCards(data.cards);
    renderGame();
    showEndModal(data.scores,data.gameOver);
  }
  if(data.type==='err'){ toast(data.msg); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMMUNICATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function sendTo(id, msg){
  if(id===myId){ handleClientMsg(msg); return; }
  const c=clientConns[id];
  if(c&&c.open) try{c.send(msg);}catch(e){}
}
function bcastAll(msg){
  // Aux clients connect√©s
  Object.values(clientConns).forEach(c=>{if(c&&c.open)try{c.send(msg);}catch(e){}});
  // √Ä soi-m√™me (h√¥te)
  handleClientMsg(msg);
}
function sendToHost(msg){
  if(isHost){ handleHostMsg(myId,msg); }
  else if(hostConn&&hostConn.open){ try{hostConn.send(msg);}catch(e){} }
}
function act(a){ sendToHost({type:'action',action:a}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT PARTAG√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function roomState(){
  return{
    phase:G.phase, currentTurn:G.currentTurn,
    deck_count:G.deck.length, discard:G.discard,
    round:G.round, initCounts:G.initCounts,
    finalRound:G.finalRound, finalBy:G.finalBy,
    players:G.players.map(p=>({id:p.id,name:p.name,avatar:p.avatar,color:p.color,total:p.total||0,connected:p.connected!==false}))
  };
}
function cardsFor(){
  const o={};G.players.forEach(p=>o[p.id]=p.cards);return o;
}
function applyRoomState(s){
  G.phase=s.phase; G.currentTurn=s.currentTurn;
  // L'h√¥te conserve son vrai tableau G.deck ‚Äî seuls les clients utilisent le stub {length}
  if(!isHost) G.deck={length:s.deck_count};
  G.discard=s.discard||G.discard;
  G.round=s.round; G.initCounts=s.initCounts||{};
  G.finalRound=s.finalRound; G.finalBy=s.finalBy;
  if(s.players){
    s.players.forEach(sp=>{
      const ex=G.players.find(p=>p.id===sp.id);
      if(ex) Object.assign(ex,{name:sp.name,avatar:sp.avatar,color:sp.color,total:sp.total,connected:sp.connected});
      else G.players.push({...sp,cards:[]});
    });
  }
}
function applyCards(payload){
  if(!payload)return;
  G.players.forEach(p=>{ if(payload[p.id]) p.cards=payload[p.id]; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGIQUE JEU (h√¥te uniquement)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processAction(pid, action){
  const player=G.players.find(p=>p.id===pid);
  if(!player) return;

  if(G.phase==='init'){
    if(action.type!=='reveal_card') return;
    if((G.initCounts[pid]||0)>=2 || player.cards[action.idx].revealed) return;
    player.cards[action.idx].revealed=true;
    G.initCounts[pid]=(G.initCounts[pid]||0)+1;
    if(G.players.every(p=>(G.initCounts[p.id]||0)>=2)){ G.phase='draw'; G.currentTurn=0; }
    bcastState(); return;
  }

  if(!curP()||curP().id!==pid) return;

  if(action.type==='draw_deck'){
    if(G.phase!=='draw') return;
    if(G.deck.length===0) reshuffleDiscard();
    if(G.deck.length===0) return;
    heldCards[pid]=G.deck.pop();
    G.phase='place';
    bcastState();
    sendHeld(pid);
  }
  else if(action.type==='draw_discard'){
    if(G.phase!=='draw'||G.discard.length===0) return;
    heldCards[pid]=G.discard.pop();
    G.phase='place';
    bcastState();
    sendHeld(pid);
  }
  else if(action.type==='place_card'){
    if(G.phase!=='place'||heldCards[pid]===undefined) return;
    const old=player.cards[action.idx].val;
    player.cards[action.idx]={val:heldCards[pid],revealed:true,elim:false};
    delete heldCards[pid];
    G.discard.push(old);
    checkElim(player.cards);
    clearHeld(pid);
    afterTurn(player);
  }
  else if(action.type==='discard_held'){
    if(G.phase!=='place'||heldCards[pid]===undefined) return;
    G.discard.push(heldCards[pid]);
    delete heldCards[pid];
    G.phase='reveal_discard';
    clearHeld(pid);
    bcastState();
  }
  else if(action.type==='reveal_card'){
    if(G.phase!=='reveal_discard'||player.cards[action.idx].revealed) return;
    player.cards[action.idx].revealed=true;
    checkElim(player.cards);
    afterTurn(player);
  }
}

function sendHeld(pid){
  const v=heldCards[pid];
  if(pid===myId){localHeld=v;renderGame();}
  else sendTo(pid,{type:'held',val:v});
}
function clearHeld(pid){
  if(pid===myId){localHeld=null;renderGame();}
  else sendTo(pid,{type:'clear_held'});
}

function checkElim(cards){
  for(let col=0;col<4;col++){
    const idxs=[col,col+4,col+8];
    if(idxs.every(i=>cards[i].revealed&&!cards[i].elim)){
      const [a,b,c]=idxs.map(i=>cards[i].val);
      if(a===b&&b===c) idxs.forEach(i=>cards[i].elim=true);
    }
  }
}
function allRev(cards){return cards.every(c=>c.revealed);}
function reshuffleDiscard(){
  if(G.discard.length<=1)return;
  const top=G.discard.pop();
  G.deck=shuffle(G.discard.slice());
  G.discard=[top];
}

function afterTurn(player){
  if(allRev(player.cards)&&!G.finalRound){G.finalRound=true;G.finalBy=player.id;}
  let next=(G.currentTurn+1)%G.players.length;
  for(let t=0;t<G.players.length;t++){if(G.players[next].connected!==false)break;next=(next+1)%G.players.length;}
  const allDone=G.players.every(p=>allRev(p.cards));
  if(G.finalRound&&(allDone||G.players[next].id===G.finalBy)){
    G.players.forEach(p=>p.cards.forEach(c=>c.revealed=true));
    endRound(); return;
  }
  G.currentTurn=next; G.phase='draw';
  bcastState();
}

function endRound(){
  const scores={};
  G.players.forEach(p=>{
    let s=p.cards.reduce((sum,c)=>sum+(c.elim?0:c.val),0);
    if(p.id===G.finalBy){
      const won=G.players.filter(q=>q.id!==p.id).every(q=>s<q.cards.reduce((sum,c)=>sum+(c.elim?0:c.val),0));
      if(!won) s*=2;
    }
    scores[p.id]=s;
    p.total=(p.total||0)+s;
  });
  G.phase='end_round';
  const gameOver=G.players.some(p=>p.total>=100);
  bcastAll({type:'end_round',roomState:roomState(),cards:cardsFor(),scores,gameOver});
}

function bcastState(){
  bcastAll({type:'state_upd',roomState:roomState(),cards:cardsFor()});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderGame(){
  const m=me(); if(!m)return;
  $('tb-r').textContent=G.round||1;
  $('tb-p').textContent=PHASE_LBL[G.phase]||G.phase;
  $('tb-d').textContent=(G.deck&&G.deck.length!==undefined)?G.deck.length:'?';

  // Message
  const c=curP(); let txt='';
  if(G.phase==='init'){const n=G.initCounts[myId]||0;txt=n<2?'Retournez '+(2-n)+' carte(s) pour d√©marrer.':'En attente des autres joueurs‚Ä¶';}
  else if(isMyTurn()){
    if(G.phase==='draw')txt='√Ä vous ! Piochez ou prenez la d√©fausse.';
    else if(G.phase==='place')txt='√âchangez ou d√©faussez la carte en main.';
    else if(G.phase==='reveal_discard')txt='Retournez une carte face cach√©e de votre grille.';
  } else if(c) txt='Tour de '+esc(c.name)+'‚Ä¶';
  $('msgbar').textContent=txt;

  // Strip joueurs
  const strip=$('strip'); strip.innerHTML='';
  G.players.forEach(p=>{
    const isCur=G.phase!=='init'&&G.players[G.currentTurn]&&G.players[G.currentTurn].id===p.id;
    const d=document.createElement('div');
    d.className='sp'+(isCur?' cur':'')+(p.id===myId?' me':'');
    d.innerHTML=`<div class="sp-av">${p.avatar}</div><div class="sp-nm">${esc(p.name)}</div><div class="sp-sc">${p.total||0}pts</div>`;
    strip.appendChild(d);
  });

  // Adversaires
  const opps=$('opps'); opps.innerHTML='';
  G.players.forEach(p=>{
    if(p.id===myId)return;
    const isCur=G.players[G.currentTurn]&&G.players[G.currentTurn].id===p.id;
    const z=document.createElement('div'); z.className='opp';
    const nm=document.createElement('div'); nm.className='opp-nm'+(isCur?' cur':''); nm.textContent=p.name+(p.connected===false?' ‚ùå':''); z.appendChild(nm);
    const g=document.createElement('div'); g.className='mgrid';
    (p.cards||[]).forEach(c=>{
      const mc=document.createElement('div');
      if(c.revealed){mc.className='mc'+(c.elim?' el':'');mc.textContent=fmt(c.val);clr(mc,c.val);}
      else{mc.className='mc bk';mc.textContent='‚úà';}
      g.appendChild(mc);
    });
    z.appendChild(g);
    const vs=(p.cards||[]).filter(c=>c.revealed&&!c.elim).reduce((s,c)=>s+c.val,0);
    const sc=document.createElement('div'); sc.style.cssText='font-size:.6rem;color:rgba(221,213,192,.38);text-align:center;margin-top:2px'; sc.textContent='visible: '+vs; z.appendChild(sc);
    opps.appendChild(z);
  });

  // Piles
  const canDraw=isMyTurn()&&G.phase==='draw';
  $('p-deck').className='pc bk'+(canDraw?'':' off');
  const disc=$('p-disc');
  const top=Array.isArray(G.discard)&&G.discard.length?G.discard[G.discard.length-1]:null;
  if(top===null||top===undefined){disc.textContent='‚Äî';disc.className='pc mt';disc.style.cssText='';}
  else{disc.textContent=fmt(top);disc.className='pc';clr(disc,top);}
  if(!canDraw||top===null) disc.classList.add('off');

  // Carte en main
  const hv=$('held-viz');
  if(isMyTurn()&&localHeld!==null&&localHeld!==undefined){hv.style.display='flex';hv.textContent=fmt(localHeld);clr(hv,localHeld);}
  else hv.style.display='none';
  $('btn-dh').style.display=(isMyTurn()&&G.phase==='place'&&localHeld!==null&&localHeld!==undefined)?'block':'none';

  // Ma grille
  $('mzone-lbl').textContent='‚úà '+esc(m.name)+' (vous)';
  const mg=$('my-grid'); mg.innerHTML='';
  let canAct=false;
  if(G.phase==='init') canAct=(G.initCounts[myId]||0)<2;
  else if(isMyTurn()&&(G.phase==='place'||G.phase==='reveal_discard')) canAct=true;

  (m.cards||[]).forEach((c,i)=>{
    const div=document.createElement('div');
    const noact=!canAct||(G.phase==='reveal_discard'&&c.revealed)||(G.phase==='init'&&c.revealed);
    div.className='mycard'+(c.revealed?' ':'  bk ')+(c.elim?' el':'')+(noact?' na':'');
    const face=document.createElement('div'); face.className='mcf';
    if(c.revealed){face.textContent=fmt(c.val);clr(face,c.val);if(c.elim){face.style.opacity='.28';face.style.textDecoration='line-through';}}
    else face.textContent='‚úà';
    div.appendChild(face);
    if(!noact){const _i=i;div.addEventListener('click',()=>onMyCard(_i));}
    mg.appendChild(div);
  });
  $('my-vs').textContent=(m.cards||[]).filter(c=>c.revealed&&!c.elim).reduce((s,c)=>s+c.val,0);
}

function onMyCard(idx){
  const m=me(); if(!m)return;
  const c=m.cards[idx];
  if(G.phase==='init'){if((G.initCounts[myId]||0)>=2||c.revealed)return;act({type:'reveal_card',idx});return;}
  if(!isMyTurn())return;
  if(G.phase==='place'){if(localHeld===null||localHeld===undefined)return;act({type:'place_card',idx});localHeld=null;return;}
  if(G.phase==='reveal_discard'){if(c.revealed)return;act({type:'reveal_card',idx});}
}

$('p-deck').addEventListener('click',()=>{if(!isMyTurn()||G.phase!=='draw')return;act({type:'draw_deck'});});
$('p-disc').addEventListener('click',()=>{
  if(!isMyTurn()||G.phase!=='draw')return;
  const top=Array.isArray(G.discard)&&G.discard.length?G.discard[G.discard.length-1]:null;
  if(top===null||top===undefined)return;
  act({type:'draw_discard'});
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIN DE MANCHE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showEndModal(scores, gameOver){
  $('ov-end').classList.add('on');
  $('end-title').textContent=gameOver?'üèÜ Fin de partie':'Fin de la manche '+(G.round||1);
  const sorted=[...G.players].sort((a,b)=>(scores[a.id]||0)-(scores[b.id]||0));
  const winner=sorted[0];
  if(gameOver){
    const gw=[...G.players].sort((a,b)=>a.total-b.total)[0];
    $('end-sub').textContent=gw.name+' gagne la partie ! üéâ';
  } else {
    $('end-sub').textContent='Vainqueur de la manche : '+winner.name+' üéâ';
  }
  const tbody=$('end-body'); tbody.innerHTML='';
  sorted.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="${p.id===winner.id?'ew':''}">${p.avatar} ${esc(p.name)}</td><td class="ep">${scores[p.id]||0}</td><td class="ep">${p.total||0}</td>`;
    tbody.appendChild(tr);
  });
  const btns=$('end-btns'); btns.innerHTML='';
  if(isHost){
    const b=document.createElement('button'); b.className='btn-p';
    b.textContent=gameOver?'Nouvelle partie':'Manche suivante ‚Üí';
    b.onclick=()=>{ sendToHost({type:gameOver?'restart':'next_round'}); };
    btns.appendChild(b);
  } else {
    const b=document.createElement('button');b.className='btn-p';b.disabled=true;b.textContent='En attente de l\'h√¥te‚Ä¶';btns.appendChild(b);
  }
  const bq=document.createElement('button');bq.className='btn-s';bq.textContent='Quitter';bq.onclick=goLobby;btns.appendChild(bq);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO-JOIN via ?join=CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const code=new URLSearchParams(location.search).get('join');
  if(code){
    setTimeout(()=>{
      $('join-box').classList.add('open');
      $('inp-code').value=code.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
      $('inp-name').focus();
    },200);
  }
})();
</script>
</body>
</html>
