<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Skyjo Multijoueur</title>
<link rel="icon" href="https://public-frontend-cos.metadl.com/mgx/img/favicon_atoms.ico" type="image/x-icon">
<script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#1a1a2e;color:#fff;min-height:100vh;overflow-x:hidden;user-select:none}
.screen{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:16px}
.screen.active{display:flex}
h1{font-size:2.2em;font-weight:700;margin-bottom:8px;background:linear-gradient(135deg,#9b59b6,#3498db);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
h2{font-size:1.4em;font-weight:600;margin-bottom:16px;color:#ccc}
.subtitle{color:#888;font-size:0.9em;margin-bottom:24px}
button{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none;padding:14px 32px;border-radius:12px;font-size:1em;font-weight:600;cursor:pointer;transition:all .2s;touch-action:manipulation;min-height:48px}
button:hover{transform:translateY(-2px);box-shadow:0 4px 15px rgba(155,89,182,.4)}
button:active{transform:translateY(0)}
button.secondary{background:rgba(255,255,255,.1);backdrop-filter:blur(10px)}
button.secondary:hover{background:rgba(255,255,255,.2);box-shadow:none}
button.danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
input{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.15);color:#fff;padding:14px 18px;border-radius:12px;font-size:1em;width:100%;max-width:320px;outline:none;transition:border-color .2s}
input:focus{border-color:#9b59b6}
input::placeholder{color:#666}
.btn-group{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:16px}
.card-container{display:flex;flex-direction:column;gap:4px;margin:8px}
.card-row{display:flex;gap:4px;justify-content:center}

/* Cards */
.card{width:52px;height:72px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2em;font-weight:700;cursor:pointer;transition:all .2s;position:relative;border:2px solid rgba(255,255,255,.1)}
.card:active{transform:scale(.95)}
.card.face-down{background:linear-gradient(135deg,#4a4a6a,#3a3a5a);color:transparent;cursor:pointer}
.card.face-down::after{content:'?';color:#666;font-size:1.4em;position:absolute}
.card.eliminated{opacity:0;pointer-events:none;transform:scale(0)}
.card.selectable{animation:pulse 1s infinite;box-shadow:0 0 12px rgba(155,89,182,.6)}
.card.highlight{box-shadow:0 0 15px rgba(255,255,255,.5)}
@keyframes pulse{0%,100%{box-shadow:0 0 8px rgba(155,89,182,.4)}50%{box-shadow:0 0 18px rgba(155,89,182,.8)}}

.card.val-neg2{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff}
.card.val-neg1{background:linear-gradient(135deg,#2ecc71,#58d68d);color:#fff}
.card.val-0{background:linear-gradient(135deg,#2980b9,#3498db);color:#fff}
.card.val-1,.card.val-2,.card.val-3,.card.val-4{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#333}
.card.val-5,.card.val-6,.card.val-7,.card.val-8{background:linear-gradient(135deg,#d35400,#e67e22);color:#fff}
.card.val-9,.card.val-10,.card.val-11,.card.val-12{background:linear-gradient(135deg,#c0392b,#e74c3c);color:#fff}

/* Piles */
.piles{display:flex;gap:20px;align-items:center;justify-content:center;margin:12px 0}
.pile{display:flex;flex-direction:column;align-items:center;gap:6px}
.pile-label{font-size:.75em;color:#888;text-transform:uppercase;letter-spacing:1px}
.pile .card{width:58px;height:80px;font-size:1.4em}

/* Player areas */
.players-area{width:100%;max-width:700px;display:flex;flex-direction:column;gap:12px;padding:8px}
.player-zone{background:rgba(255,255,255,.05);border-radius:12px;padding:10px;border:2px solid transparent;transition:border-color .3s}
.player-zone.current-turn{border-color:#9b59b6}
.player-zone.is-me{border-color:rgba(52,152,219,.5)}
/*.player-zone.is-me.current-turn {border-color:#9b59b6;box-shadow:0 0 20px rgba(155,89,182,.3)} */

/* Fond prononcÃ© quand c'est le tour du joueur local */
.player-zone.is-me.current-turn {
  border-color: #9b59b6;
  box-shadow: 0 0 20px rgba(155,89,182,.3);
  background: rgba(155,89,182,.18);          /* â† NOUVEAU : fond violet plus marquÃ© */
  animation: myTurnPulse 2s ease-in-out infinite;  /* â† NOUVEAU : lÃ©gÃ¨re animation */
}
@keyframes myTurnPulse {
  0%, 100% { background: rgba(155,89,182,.12); box-shadow: 0 0 20px rgba(155,89,182,.3); }
  50%       { background: rgba(155,89,182,.28); box-shadow: 0 0 35px rgba(155,89,182,.6); }
}

.player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding:0 4px}
.player-name::after {font-weight:600;font-size:.9em} 
.player-score{font-size:.85em;color:#888}
.player-badge{font-size:.7em;padding:2px 8px;border-radius:20px;background:rgba(155,89,182,.3);color:#bb86fc}
.turn-indicator{font-size:.7em;color:#f1c40f;font-weight:600}

/* Lobby */
.lobby-box{background:rgba(255,255,255,.05);border-radius:16px;padding:24px;max-width:400px;width:100%;text-align:center}
.lobby-players{list-style:none;margin:16px 0;text-align:left}
.lobby-players li{padding:10px 16px;background:rgba(255,255,255,.05);border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.lobby-players li .host-badge{font-size:.7em;background:#9b59b6;padding:2px 8px;border-radius:10px}
#qr-container{margin:16px auto;border-radius:12px;background:#fff;padding:8px;display:inline-block}
#qr-container img{display:block;border-radius:4px}
.room-code{font-family:monospace;font-size:1.8em;letter-spacing:4px;color:#bb86fc;margin:8px 0}
.copy-btn{font-size:.8em;padding:8px 16px;margin-top:4px}

/* Game header */
.game-header{width:100%;max-width:700px;display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,.05);border-radius:12px;margin-bottom:8px}
.game-status{font-size:.85em;color:#ccc;text-align:center;flex:1}
.round-info{font-size:.75em;color:#888}

/* Action bar */
.action-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(26,26,46,.95);backdrop-filter:blur(10px);padding:12px 16px;display:flex;justify-content:center;gap:10px;border-top:1px solid rgba(255,255,255,.1);z-index:100}
.action-bar button{padding:10px 20px;font-size:.85em}

/* Scores screen */
.scores-table{width:100%;max-width:500px;border-collapse:collapse;margin:16px 0}
.scores-table th,.scores-table td{padding:12px 16px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1)}
.scores-table th{color:#888;font-weight:600;font-size:.85em;text-transform:uppercase}
.scores-table tr.winner{background:rgba(46,204,113,.15)}
.scores-table td.total{font-weight:700;color:#bb86fc}

/* Winner zoom animation */
.winner-name{display:inline-block;animation:winnerZoom 1.5s ease-in-out infinite alternate;font-size:1.3em;font-weight:800;color:#f1c40f}
@keyframes winnerZoom{0%{transform:scale(1);text-shadow:0 0 5px rgba(241,196,15,.3)}100%{transform:scale(1.15);text-shadow:0 0 20px rgba(241,196,15,.6)}}

/* Toast */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(155,89,182,.9);color:#fff;padding:12px 24px;border-radius:12px;font-size:.9em;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none}
.toast.show{opacity:1}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:300;padding:16px}
.modal-overlay.active{display:flex}
.modal{background:#2a2a4a;border-radius:16px;padding:24px;max-width:400px;width:100%;text-align:center}
.modal h3{margin-bottom:12px;font-size:1.2em}
.modal p{color:#aaa;margin-bottom:16px;font-size:.9em}

/* Scrollable game */
.game-content{width:100%;overflow-y:auto;padding-bottom:80px;display:flex;flex-direction:column;align-items:center}

/* Boom animation for column elimination */
.boom-overlay{position:fixed;inset:0;pointer-events:none;z-index:150}
.boom-particle{position:absolute;border-radius:50%;pointer-events:none;animation:boomExplode .8s ease-out forwards}
@keyframes boomExplode{
  0%{opacity:1;transform:translate(0,0) scale(1)}
  100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(0)}
}
.boom-text{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);font-size:3em;font-weight:900;color:#f1c40f;text-shadow:0 0 30px rgba(241,196,15,.8),0 0 60px rgba(241,196,15,.4);z-index:160;pointer-events:none;animation:boomTextAnim .8s ease-out forwards}
@keyframes boomTextAnim{
  0%{transform:translate(-50%,-50%) scale(0);opacity:1}
  50%{transform:translate(-50%,-50%) scale(1.3);opacity:1}
  100%{transform:translate(-50%,-50%) scale(1);opacity:0}
}

/* Round reveal screen */
.reveal-summary{text-align:center;max-width:500px;width:100%}
.reveal-summary .player-result{background:rgba(255,255,255,.05);border-radius:12px;padding:12px 16px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
.reveal-summary .player-result .score-val{font-size:1.3em;font-weight:700;color:#bb86fc}
.reveal-summary .player-result.best{border:2px solid #2ecc71;background:rgba(46,204,113,.1)}

/* Leaderboard */
.leaderboard-box{background:rgba(255,255,255,.05);border-radius:16px;padding:20px;max-width:400px;width:100%;margin-top:16px}
.leaderboard-box h3{font-size:1em;color:#888;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px}
.lb-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.05)}
.lb-row:last-child{border-bottom:none}
.lb-rank{width:30px;font-weight:700;color:#f1c40f}
.lb-name{flex:1;font-weight:500}
.lb-wins{color:#2ecc71;font-weight:700}
.lb-games{color:#888;font-size:.85em;margin-left:8px}

/* Responsive */
@media(max-width:400px){
  .card{width:44px;height:62px;font-size:1em;border-radius:6px}
  .pile .card{width:50px;height:70px;font-size:1.2em}
  h1{font-size:1.8em}
}

/* Reconnect overlay */
#reconnect-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center;padding:24px}
#reconnect-overlay.show{display:flex}
#reconnect-overlay h3{color:#f1c40f;font-size:1.3em}
#reconnect-overlay p{color:#aaa;font-size:.9em}
.reconnect-spinner{width:48px;height:48px;border:4px solid rgba(155,89,182,.3);border-top-color:#9b59b6;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Connecting screen */
#screen-connecting { background: #1a1a2e; }
.connect-box { text-align:center; max-width:360px; width:100%; padding:32px 24px; }
.connect-box h2 { margin-bottom:6px; }
.connect-subtitle { color:#888; font-size:.9em; margin-bottom:28px; }
.connect-progress-track { background:rgba(255,255,255,.08); border-radius:99px; height:6px; width:100%; margin:18px 0 8px; overflow:hidden; }
.connect-progress-bar { height:6px; border-radius:99px; background:linear-gradient(90deg,#9b59b6,#3498db); width:0%; transition:width .4s ease; }
.connect-status { font-size:.85em; color:#aaa; min-height:1.4em; margin-bottom:20px; }
.connect-steps { list-style:none; text-align:left; margin:0 0 24px; display:flex; flex-direction:column; gap:10px; }
.connect-steps li { display:flex; align-items:center; gap:10px; font-size:.88em; color:#666; transition:color .3s; }
.connect-steps li.done { color:#2ecc71; }
.connect-steps li.active { color:#fff; }
.connect-steps li.error { color:#e74c3c; }
.step-icon { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.75em; flex-shrink:0; background:rgba(255,255,255,.06); transition:background .3s; }
.connect-steps li.done .step-icon { background:#2ecc71; }
.connect-steps li.active .step-icon { background:#9b59b6; animation:stepPulse 1s ease-in-out infinite; }
.connect-steps li.error .step-icon { background:#e74c3c; }
@keyframes stepPulse { 0%,100%{box-shadow:0 0 0 0 rgba(155,89,182,.5)} 50%{box-shadow:0 0 0 6px rgba(155,89,182,0)} }
.connect-error-box { display:none; background:rgba(231,76,60,.1); border:1px solid rgba(231,76,60,.3); border-radius:12px; padding:14px 16px; margin-bottom:16px; text-align:left; }
.connect-error-box.show { display:block; }
.connect-error-code { font-family:monospace; font-size:.78em; color:#e74c3c; background:rgba(0,0,0,.3); padding:6px 10px; border-radius:6px; margin-top:8px; word-break:break-all; }
.connect-error-msg { font-size:.85em; color:#e74c3c; margin-bottom:4px; font-weight:600; }

/* Fullscreen button */
#fullscreen-btn{position:fixed;top:10px;right:10px;z-index:500;background:rgba(155,89,182,.7);border:none;color:#fff;border-radius:10px;padding:8px 12px;font-size:1.2em;cursor:pointer;backdrop-filter:blur(10px);min-height:42px;min-width:42px;line-height:1;transition:background .2s;box-shadow:0 2px 8px rgba(0,0,0,.3)}
#fullscreen-btn:hover,#fullscreen-btn:active{background:rgba(155,89,182,1)}

/* Fullscreen tip banner (iOS) */
#fs-tip {
  position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
  background: rgba(26,26,46,.97); color: #fff;
  padding: 14px 20px; border-radius: 14px; font-size: .82em;
  z-index: 600; text-align: center; max-width: 300px; display: none;
  border: 1px solid rgba(155,89,182,.4);
  box-shadow: 0 4px 20px rgba(0,0,0,.5);
}
#fs-tip button { padding: 8px 16px; font-size: .85em; margin-top: 10px; }
</style>
</head>
<body>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FULLSCREEN BUTTON -->
<button id="fullscreen-btn" onclick="toggleFullscreen()" title="Plein Ã©cran">â›¶</button>

<!-- iOS FULLSCREEN TIP -->
<div id="fs-tip">
  <div>ğŸ“± <strong>iOS Safari</strong> ne supporte pas le plein Ã©cran natif.</div>
  <div style="margin-top:6px;color:#aaa">
    Pour jouer en plein Ã©cran :<br>
    Appuyez sur <strong>â–¡â†‘</strong> puis <em>"Sur l'Ã©cran d'accueil"</em>
  </div>
  <div style="margin-top:10px;display:flex;justify-content:center;gap:8px">
    <button onclick="closeFsTip()">OK compris</button>
  </div>
</div>

<!-- BOOM OVERLAY -->
<div class="boom-overlay" id="boom-overlay"></div>

<!-- MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 id="modal-title"></h3>
    <p id="modal-text"></p>
    <div class="btn-group" id="modal-buttons"></div>
  </div>
</div>

<!-- SCREEN: MENU -->
<div class="screen active" id="screen-menu">
  <h1>SKYJO</h1>
  <p class="subtitle">Jeu de cartes multijoueur V1.1.1</p>
  <div style="margin:12px 0;width:100%;max-width:320px">
    <input type="text" id="player-name" placeholder="Votre pseudo" maxlength="12" autocomplete="off">
  </div>
  <div class="btn-group" style="margin-top:8px">
    <button onclick="createGame()">CrÃ©er une partie</button>
    <button class="secondary" onclick="showJoinScreen()">Rejoindre</button>
  </div>
  <!-- Persistent Leaderboard -->
  <div class="leaderboard-box" id="menu-leaderboard" style="margin-top:24px"></div>
</div>

<!-- SCREEN: JOIN -->
<div class="screen" id="screen-join">
  <h1>SKYJO</h1>
  <h2>Rejoindre une partie</h2>
  <div style="width:100%;max-width:320px">
    <input type="text" id="room-input" placeholder="Code de la salle" maxlength="6" autocomplete="off" style="text-transform:uppercase;text-align:center;font-size:1.4em;letter-spacing:4px">
  </div>
  <div class="btn-group">
    <button onclick="joinGame()">Rejoindre</button>
    <button class="secondary" onclick="showScreen('screen-menu')">Retour</button>
  </div>
</div>

<!-- SCREEN: CONNECTING -->
<div class="screen" id="screen-connecting">
  <div class="connect-box">
    <h2>ğŸ”— Connexion</h2>
    <p class="connect-subtitle" id="connect-room-label">Salle <strong id="connect-room-code"></strong></p>
    <div class="connect-progress-track">
      <div class="connect-progress-bar" id="connect-bar"></div>
    </div>
    <p class="connect-status" id="connect-status">Initialisation...</p>
    <ul class="connect-steps">
      <li id="cstep-p2p">
        <span class="step-icon" id="cstep-p2p-icon">1</span>
        Connexion serveur
      </li>
      <li id="cstep-tracker">
        <span class="step-icon" id="cstep-tracker-icon">2</span>
        Connexion Ã  Firebase
      </li>
      <li id="cstep-host">
        <span class="step-icon" id="cstep-host-icon">3</span>
        Recherche de la salle
      </li>
      <li id="cstep-join">
        <span class="step-icon" id="cstep-join-icon">4</span>
        Rejoindre la partie
      </li>
    </ul>
    <div class="connect-error-box" id="connect-error-box">
      <p class="connect-error-msg" id="connect-error-msg">Erreur de connexion</p>
      <div class="connect-error-code" id="connect-error-code"></div>
    </div>
    <div class="btn-group">
      <button class="danger" onclick="cancelConnect()" id="connect-cancel-btn">Annuler</button>
      <button onclick="retryConnect()" id="connect-retry-btn" style="display:none">ğŸ”„ RÃ©essayer</button>
    </div>
  </div>
</div>

<!-- SCREEN: LOBBY -->
<div class="screen" id="screen-lobby">
  <div class="lobby-box">
    <h2>Salle d'attente</h2>
    <p class="subtitle">Partagez le code ou le QR code</p>
    <div class="room-code" id="lobby-code"></div>
    <button class="copy-btn secondary" onclick="copyCode()">ğŸ“‹ Copier le lien</button>
    <div id="qr-container"></div>
    <ul class="lobby-players" id="lobby-players"></ul>
    <div class="btn-group">
      <button id="start-btn" onclick="startGame()" style="display:none">Lancer la partie</button>
      <button class="danger" onclick="leaveLobby()">Quitter</button>
    </div>
  </div>
</div>

<!-- SCREEN: GAME -->
<div class="screen" id="screen-game" style="justify-content:flex-start;padding-top:8px">
  <div class="game-header">
    <div class="round-info" id="round-info">Manche 1</div>
    <div class="game-status" id="game-status">En attente...</div>
    <button class="secondary" style="padding:6px 12px;font-size:.75em" onclick="showRules()">?</button>
  </div>
  <div class="game-content" id="game-content">
    <div class="piles" id="piles-area"></div>
    <div class="players-area" id="players-area"></div>
  </div>
  <div class="action-bar" id="action-bar" style="display:none"></div>
</div>

<!-- SCREEN: ROUND REVEAL (show all grids + scores before table) -->
<div class="screen" id="screen-round-reveal">
  <h2>ğŸ“Š Fin de la manche</h2>
  <p class="subtitle" id="reveal-subtitle"></p>
  <div class="reveal-summary" id="reveal-summary"></div>
  <div class="btn-group" style="margin-top:20px">
    <button onclick="showRoundScoreTable()">Voir le tableau des scores</button>
  </div>
</div>

<!-- SCREEN: ROUND SCORES -->
<div class="screen" id="screen-round-scores">
  <h2>Tableau des scores</h2>
  <table class="scores-table" id="round-scores-table"></table>
  <div class="btn-group">
    <button id="next-round-btn" onclick="nextRound()">Manche suivante</button>
  </div>
</div>

<!-- SCREEN: FINAL SCORES -->
<div class="screen" id="screen-final-scores">
  <h1>ğŸ† Fin de partie</h1>
  <div id="final-winner-banner" style="margin:16px 0"></div>
  <table class="scores-table" id="final-scores-table"></table>
  <div class="leaderboard-box" id="final-leaderboard" style="margin-top:16px"></div>
  <div class="btn-group">
    <button onclick="backToMenu()">Menu principal</button>
  </div>
</div>




<script>
// ============================================================
// SKYJO MULTIPLAYER â€” Client WebSocket
// ============================================================

// âš™ï¸ Remplacez par l'URL de votre serveur Render aprÃ¨s dÃ©ploiement
const WS_URL = 'https://skyjo-vpxh.onrender.com';

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CARD_COUNTS = {'-2':5,'-1':10,'0':15,'1':10,'2':10,'3':10,'4':10,'5':10,'6':10,'7':10,'8':10,'9':10,'10':10,'11':10,'12':10};
const ROWS=3, COLS=4, MAX_PLAYERS=8, END_SCORE=100;

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws            = null;
let wsReady       = false;
let isHost        = false;
let myName        = '';
let roomCode      = '';
let gameState     = null;
let myPlayerId    = 'p_' + Math.random().toString(36).substr(2,9);
let currentScreen = 'screen-menu';
let pingInterval  = null;
let reconnectTimer= null;
let reconnectCount= 0;

// Connect screen
let _connectTimer    = null;
let _connectElapsed  = 0;
let _connectRoomCode = '';
let _connectIsHost   = false;
let _pendingAction   = null; // action Ã  rejouer aprÃ¨s reconnexion WS

// â”€â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  return new Promise((resolve, reject) => {
    if (ws && ws.readyState === WebSocket.OPEN) { resolve(); return; }
    if (ws) { try { ws.close(); } catch {} ws = null; }

    const url = WS_URL !== 'wss://VOTRE-SERVEUR.onrender.com'
      ? WS_URL
      : null;

    if (!url) {
      reject(new Error('WS_URL non configurÃ©e'));
      return;
    }

    ws = new WebSocket(url);

    const timeout = setTimeout(() => {
      reject(new Error('Timeout connexion WebSocket (30s)\nVÃ©rifiez que le serveur Render est dÃ©marrÃ©.'));
    }, 30000);

    ws.onopen = () => {
      clearTimeout(timeout);
      wsReady = true;
      reconnectCount = 0;
      startPing();
      resolve();
    };

    ws.onerror = (e) => {
      clearTimeout(timeout);
      reject(new Error('WebSocket error â€” serveur inaccessible'));
    };

    ws.onclose = () => {
      wsReady = false;
      stopPing();
      // Reconnexion automatique si on Ã©tait en jeu
      if (gameState && roomCode && !isHost) {
        scheduleReconnect();
      }
    };

    ws.onmessage = (e) => {
      let msg;
      try { msg = JSON.parse(e.data); } catch { return; }
      handleServerMessage(msg);
    };
  });
}

function send(data) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(data));
  }
}

function startPing() {
  stopPing();
  pingInterval = setInterval(() => {
    if (ws && ws.readyState === WebSocket.OPEN) send({ type: 'ping' });
  }, 25000);
}
function stopPing() {
  if (pingInterval) { clearInterval(pingInterval); pingInterval = null; }
}

function scheduleReconnect() {
  if (reconnectTimer) return;
  if (reconnectCount >= 5) {
    toast('Connexion perdue. Retour au menu.');
    leaveRoom(); showScreen('screen-menu'); return;
  }
  reconnectCount++;
  const delay = Math.min(1000 * reconnectCount, 5000);
  toast(`Reconnexion dans ${Math.round(delay/1000)}s... (${reconnectCount}/5)`);
  reconnectTimer = setTimeout(async () => {
    reconnectTimer = null;
    try {
      await connectWS();
      // Rejoindre Ã  nouveau
      send({ type: 'join', code: roomCode, playerId: myPlayerId, name: myName });
    } catch { scheduleReconnect(); }
  }, delay);
}

function disconnectWS() {
  stopPing();
  if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
  if (ws) { try { ws.close(); } catch {} ws = null; }
  wsReady = false;
}

function leaveRoom() {
  disconnectWS();
  if (_connectTimer) { clearInterval(_connectTimer); _connectTimer = null; }
  gameState  = null;
  isHost     = false;
  roomCode   = '';
}

// â”€â”€â”€ Messages serveur â†’ client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleServerMessage(msg) {
  switch (msg.type) {

    case 'created':
      connectStep('tracker','done','2');
      connectStep('host','done','3');
      connectSuccess();
      break;

    case 'joined':
      connectStep('tracker','done','2');
      connectStep('host','active','3');
      connectProgress(60, 'En attente de l\'hÃ´te...');
      // Timeout si l'hÃ´te ne rÃ©pond pas avec un state
      _connectElapsed = 0;
      if (_connectTimer) clearInterval(_connectTimer);
      _connectTimer = setInterval(() => {
        _connectElapsed++;
        const left = 20 - _connectElapsed;
        connectProgress(60 + _connectElapsed, 'En attente de l\'hÃ´te... (' + left + 's)');
        if (_connectElapsed >= 20) {
          clearInterval(_connectTimer); _connectTimer = null;
          connectStep('host','error','3');
          connectError('L\'hÃ´te ne rÃ©pond pas',
            'ERR_HOST_TIMEOUT | room=' + msg.code + '\nL\'hÃ´te est peut-Ãªtre dÃ©connectÃ©.');
        }
      }, 1000);
      break;

    case 'state':
      if (_connectTimer) { clearInterval(_connectTimer); _connectTimer = null; }
      gameState = msg.state;
      if (currentScreen === 'screen-connecting') {
        connectSuccess();
      } else {
        renderFromState();
      }
      break;

    case 'player_join':
      // L'hÃ´te reÃ§oit la demande d'un nouveau joueur
      if (!isHost || !gameState) return;
      if (gameState.phase !== 'lobby') { broadcastState(); return; }
      if (gameState.players.length >= MAX_PLAYERS) return;
      if (!gameState.players.find(p => p.id === msg.playerId)) {
        gameState.players.push({ id: msg.playerId, name: msg.name, isHost: false });
        gameState.totalScores[msg.playerId] = 0;
        toast(msg.name + ' a rejoint !');
      }
      broadcastState();
      break;

    case 'player_left':
      if (!isHost || !gameState) return;
      handlePlayerLeave(msg.playerId);
      break;

    case 'host_left':
      toast('L\'hÃ´te a quittÃ© la partie.');
      leaveRoom(); showScreen('screen-menu');
      break;

    case 'action':
      if (isHost) handleAction(msg.playerId, msg.data);
      break;

    case 'toast':
      if (!isHost) toast(msg.msg);
      break;

    case 'boom':
      if (!isHost) triggerBoom();
      break;

    case 'error':
      if (currentScreen === 'screen-connecting') {
        connectStep('host','error','3');
        connectError(msg.msg, msg.code + '\n' + (msg.detail || ''));
      } else {
        toast(msg.msg);
      }
      break;

    case 'pong':
      break;
  }
}

// â”€â”€â”€ Leaderboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLeaderboard(){try{return JSON.parse(localStorage.getItem('skyjo_lb')||'{}');}catch{return {};}}
function saveLeaderboard(lb){try{localStorage.setItem('skyjo_lb',JSON.stringify(lb));}catch{}}
function updateLeaderboard(name,won){const lb=getLeaderboard();if(!lb[name])lb[name]={wins:0,games:0};lb[name].games++;if(won)lb[name].wins++;saveLeaderboard(lb);}
function renderLeaderboard(id){
  const lb=getLeaderboard(),el=document.getElementById(id); if(!el)return;
  const rows=Object.entries(lb).sort((a,b)=>b[1].wins-a[1].wins).slice(0,10);
  if(!rows.length){el.innerHTML='<h3>ğŸ† Classement</h3><p style="color:#666;font-size:.85em">Aucune partie terminÃ©e</p>';return;}
  el.innerHTML='<h3>ğŸ† Classement</h3>'+rows.map(([n,d],i)=>`<div class="lb-row"><span class="lb-rank">${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||i+1}</span><span class="lb-name">${n}</span><span class="lb-wins">${d.wins}W</span><span class="lb-games">${d.games}G</span></div>`).join('');
}

// â”€â”€â”€ Boom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerBoom(){
  const o=document.getElementById('boom-overlay');o.innerHTML='';
  const colors=['#f1c40f','#e74c3c','#e67e22','#9b59b6','#2ecc71','#3498db'];
  for(let i=0;i<30;i++){const p=document.createElement('div');p.className='boom-particle';const s=6+Math.random()*12,a=Math.random()*Math.PI*2,d=80+Math.random()*200;p.style.cssText=`width:${s}px;height:${s}px;background:${colors[i%6]};left:50%;top:50%;--dx:${Math.cos(a)*d}px;--dy:${Math.sin(a)*d}px;`;o.appendChild(p);}
  const t=document.createElement('div');t.className='boom-text';t.textContent='ğŸ’¥ BOOM!';o.appendChild(t);
  setTimeout(()=>o.innerHTML='',1000);
}

// â”€â”€â”€ Fullscreen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;
function toggleFullscreen(){
  const btn=document.getElementById('fullscreen-btn');
  if(isIOS){const t=document.getElementById('fs-tip');t.style.display=t.style.display==='block'?'none':'block';return;}
  const isFs=!!(document.fullscreenElement||document.webkitFullscreenElement);
  if(!isFs){const r=document.documentElement.requestFullscreen||document.documentElement.webkitRequestFullscreen;if(r)r.call(document.documentElement).then(()=>btn.textContent='âœ•').catch(()=>toast('Plein Ã©cran non disponible'));}
  else{(document.exitFullscreen||document.webkitExitFullscreen).call(document);btn.textContent='â›¶';}
}
function closeFsTip(){document.getElementById('fs-tip').style.display='none';}
['fullscreenchange','webkitfullscreenchange'].forEach(ev=>document.addEventListener(ev,()=>{document.getElementById('fullscreen-btn').textContent=!!(document.fullscreenElement||document.webkitFullscreenElement)?'âœ•':'â›¶';}));
window.addEventListener('load',()=>{if(isIOS){document.getElementById('fullscreen-btn').textContent='ğŸ“±';if(!localStorage.getItem('skyjo_fs_shown')){setTimeout(()=>{document.getElementById('fs-tip').style.display='block';localStorage.setItem('skyjo_fs_shown','1');},1500);}}});

// â”€â”€â”€ Connect screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectStep(id,state,icon){
  const el=document.getElementById('cstep-'+id),ic=document.getElementById('cstep-'+id+'-icon');
  if(!el)return;el.className=state;ic.textContent=state==='done'?'âœ“':state==='error'?'âœ—':icon;
}
function connectProgress(pct,status){
  document.getElementById('connect-bar').style.width=pct+'%';
  if(status!==undefined)document.getElementById('connect-status').textContent=status;
}
function connectError(msg,code){
  document.getElementById('connect-error-box').classList.add('show');
  document.getElementById('connect-error-msg').textContent=msg;
  document.getElementById('connect-error-code').textContent=code;
  document.getElementById('connect-retry-btn').style.display='';
  document.getElementById('connect-cancel-btn').textContent='Retour au menu';
  if(_connectTimer){clearInterval(_connectTimer);_connectTimer=null;}
}
function cancelConnect(){
  if(_connectTimer){clearInterval(_connectTimer);_connectTimer=null;}
  leaveRoom(); showScreen('screen-menu');
}
function retryConnect(){
  document.getElementById('connect-error-box').classList.remove('show');
  document.getElementById('connect-retry-btn').style.display='none';
  document.getElementById('connect-cancel-btn').textContent='Annuler';
  if(_connectIsHost) createGame();
  else{document.getElementById('room-input').value=_connectRoomCode;joinGame();}
}
function showConnectScreen(code,asHost){
  _connectRoomCode=code;_connectIsHost=asHost;_connectElapsed=0;
  document.getElementById('connect-room-code').textContent=code;
  document.getElementById('connect-bar').style.width='0%';
  document.getElementById('connect-status').textContent='Connexion au serveur...';
  document.getElementById('connect-error-box').classList.remove('show');
  document.getElementById('connect-retry-btn').style.display='none';
  document.getElementById('connect-cancel-btn').textContent='Annuler';
  ['p2p','tracker','host','join'].forEach((s,i)=>connectStep(s,'',String(i+1)));
  showScreen('screen-connecting');
  setTimeout(()=>{connectStep('p2p','active','1');connectProgress(8,'Connexion WebSocket...');},100);
}
function connectSuccess(){
  if(_connectTimer){clearInterval(_connectTimer);_connectTimer=null;}
  connectStep('host','done','3');connectStep('join','active','4');connectProgress(85,'Synchronisation...');
  setTimeout(()=>{connectStep('join','done','4');connectProgress(100,'ConnectÃ© !');},400);
  setTimeout(()=>{if(gameState)renderFromState();else showLobby();},800);
}

// â”€â”€â”€ Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getName(){let n=document.getElementById('player-name').value.trim();if(!n)n='Joueur'+Math.floor(Math.random()*999);return n;}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');currentScreen=id;if(id==='screen-menu')renderLeaderboard('menu-leaderboard');}
function showJoinScreen(){myName=getName();showScreen('screen-join');document.getElementById('room-input').focus();}

// â”€â”€â”€ Create game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function createGame() {
  myName = getName();
  roomCode = Math.random().toString(36).substr(2,5).toUpperCase();
  isHost = true;
  leaveRoom(); isHost = true; // leaveRoom reset isHost

  showConnectScreen(roomCode, true);

  try {
    connectStep('p2p','active','1');
    connectProgress(15,'Connexion au serveur...');
    await connectWS();

    connectStep('p2p','done','1');
    connectStep('tracker','active','2');
    connectProgress(35,'CrÃ©ation de la salle...');

    gameState = {
      phase:'lobby',
      players:[{id:myPlayerId,name:myName,isHost:true}],
      round:0,
      totalScores:{[myPlayerId]:0}
    };

    send({ type:'create', code:roomCode, playerId:myPlayerId, name:myName });

  } catch(e) {
    console.error(e);
    connectStep('p2p','error','1');
    connectError('Impossible de joindre le serveur', 'ERR_WS_CONNECT | ' + e.message + '\n\nVÃ©rifiez que le serveur Render est bien dÃ©marrÃ©.\nURL configurÃ©e : ' + WS_URL);
    isHost = false;
  }
}

// â”€â”€â”€ Join game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function joinGame() {
  myName = getName();
  const code = document.getElementById('room-input').value.trim().toUpperCase();
  if (!code) { toast('Entrez un code'); return; }
  roomCode = code;
  isHost = false;
  leaveRoom(); isHost = false; roomCode = code;

  showConnectScreen(code, false);

  try {
    connectStep('p2p','active','1');
    connectProgress(15,'Connexion au serveur...');
    await connectWS();

    connectStep('p2p','done','1');
    connectStep('tracker','active','2');
    connectProgress(40,'Recherche de la salle...');

    send({ type:'join', code, playerId:myPlayerId, name:myName });

  } catch(e) {
    console.error(e);
    connectStep('p2p','error','1');
    connectError('Impossible de joindre le serveur', 'ERR_WS_CONNECT | ' + e.message + '\n\nVÃ©rifiez que le serveur Render est bien dÃ©marrÃ©.\nURL configurÃ©e : ' + WS_URL);
  }
}

// â”€â”€â”€ Host actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handlePlayerLeave(playerId){
  if(!gameState)return;
  if(gameState.phase==='lobby'){
    gameState.players=gameState.players.filter(p=>p.id!==playerId);
    delete gameState.totalScores[playerId];
    broadcastState(); toast('Un joueur a quittÃ©');
  }
}
function handleAction(playerId, data){
  if(!isHost||!gameState)return;
  handlePlayerAction(playerId, data);
}

// â”€â”€â”€ Broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function broadcastState(){send({type:'state',state:gameState});renderFromState();}
function broadcastToast(msg){send({type:'toast',msg});toast(msg);}
function broadcastBoom(){send({type:'boom'});triggerBoom();}
function sendAction(data){send({type:'action',playerId:myPlayerId,data});}

// â”€â”€â”€ Lobby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLobby(){showScreen('screen-lobby');document.getElementById('lobby-code').textContent=roomCode;generateQR();renderLobby();}
function generateQR(){
  const url=window.location.href.split('?')[0]+'?room='+roomCode;
  const c=document.getElementById('qr-container');c.innerHTML='';
  try{new QRCode(c,{text:url,width:180,height:180,colorDark:'#1a1a2e',colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.M});}
  catch(e){c.innerHTML='<p style="color:#333;font-size:.75em;padding:8px;word-break:break-all">'+url+'</p>';}
}
function renderLobby(){
  if(!gameState)return;
  document.getElementById('lobby-players').innerHTML=gameState.players.map(p=>`<li>${p.name}${p.isHost?' <span class="host-badge">HÃ”TE</span>':''}${p.id===myPlayerId?' (vous)':''}</li>`).join('');
  document.getElementById('start-btn').style.display=(isHost&&gameState.players.length>=2)?'':'none';
}
function copyCode(){const url=window.location.href.split('?')[0]+'?room='+roomCode;navigator.clipboard.writeText(url).then(()=>toast('Lien copiÃ© !')).catch(()=>toast(roomCode));}
function leaveLobby(){leaveRoom();showScreen('screen-menu');}
function backToMenu(){leaveRoom();showScreen('screen-menu');}

// â”€â”€â”€ Deck â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createDeck(){const d=[];for(const[v,c]of Object.entries(CARD_COUNTS))for(let i=0;i<c;i++)d.push(parseInt(v));return shuffle(d);}
function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}return b;}

// â”€â”€â”€ Game logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(){if(!isHost||gameState.players.length<2)return;initRound();}
function initRound(){
  const deck=createDeck(),hands={},revealed={};
  gameState.players.forEach(p=>{const cards=[];for(let r=0;r<ROWS;r++){const row=[];for(let c=0;c<COLS;c++)row.push(deck.pop());cards.push(row);}hands[p.id]=cards;revealed[p.id]=Array.from({length:ROWS},()=>[false,false,false,false]);});
  Object.assign(gameState,{round:gameState.round+1,phase:'reveal_initial',deck,discard:[deck.pop()],hands,revealed,
    eliminated:Object.fromEntries(gameState.players.map(p=>[p.id,[false,false,false,false]])),
    currentPlayerIndex:-1,initialReveals:Object.fromEntries(gameState.players.map(p=>[p.id,0])),
    turnPhase:null,drawnCard:null,drawnFrom:null,drawnByPlayerId:null,
    lastRoundTriggeredBy:null,lastRoundTurnsLeft:-1,roundScores:{}});
  broadcastToast('Manche '+gameState.round+' â€” Retournez 2 cartes !');
  broadcastState();
}
function performAction(action){if(isHost)handlePlayerAction(myPlayerId,action);else sendAction(action);}
function handlePlayerAction(pid,action){if(!isHost||!gameState)return;switch(gameState.phase){case 'reveal_initial':handleRevealInitial(pid,action);break;case 'playing':handlePlayingAction(pid,action);break;}}
function handleRevealInitial(pid,action){
  if(action.type!=='reveal')return;
  const{row,col}=action;
  if(gameState.revealed[pid][row][col]||gameState.eliminated[pid][col]||gameState.initialReveals[pid]>=2)return;
  gameState.revealed[pid][row][col]=true;gameState.initialReveals[pid]++;
  if(gameState.players.every(p=>gameState.initialReveals[p.id]>=2)){
    let max=-Infinity,si=0;
    gameState.players.forEach((p,i)=>{let s=0;for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(gameState.revealed[p.id][r][c])s+=gameState.hands[p.id][r][c];if(s>max){max=s;si=i;}});
    gameState.currentPlayerIndex=si;gameState.phase='playing';gameState.turnPhase='draw';
    broadcastToast(gameState.players[si].name+' commence !');
  }
  broadcastState();
}
function handlePlayingAction(pid,action){
  const cur=gameState.players[gameState.currentPlayerIndex];if(pid!==cur.id)return;
  switch(action.type){
    case 'draw_deck': if(gameState.turnPhase!=='draw')return;if(!gameState.deck.length)reshuffleDeck();gameState.drawnCard=gameState.deck.pop();gameState.drawnFrom='deck';gameState.drawnByPlayerId=pid;gameState.turnPhase='drawn_from_pile';broadcastState();break;
    case 'draw_discard': if(gameState.turnPhase!=='draw'||!gameState.discard.length)return;gameState.drawnCard=gameState.discard.pop();gameState.drawnFrom='discard';gameState.drawnByPlayerId=pid;gameState.turnPhase='place_mandatory';broadcastState();break;
    case 'place_card':{if(gameState.turnPhase!=='drawn_from_pile'&&gameState.turnPhase!=='place_mandatory')return;const{row,col}=action;if(gameState.eliminated[pid][col])return;const old=gameState.hands[pid][row][col];gameState.hands[pid][row][col]=gameState.drawnCard;gameState.revealed[pid][row][col]=true;gameState.discard.push(old);gameState.drawnCard=null;gameState.drawnByPlayerId=null;checkColElim(pid);endTurn();break;}
    case 'discard_drawn': if(gameState.turnPhase!=='drawn_from_pile')return;gameState.discard.push(gameState.drawnCard);gameState.drawnCard=null;gameState.drawnByPlayerId=null;gameState.turnPhase='must_reveal';broadcastState();break;
    case 'reveal_card':{if(gameState.turnPhase!=='must_reveal')return;const{row:rr,col:rc}=action;if(gameState.revealed[pid][rr][rc]||gameState.eliminated[pid][rc])return;gameState.revealed[pid][rr][rc]=true;checkColElim(pid);endTurn();break;}
  }
}
function checkColElim(pid){for(let c=0;c<COLS;c++){if(gameState.eliminated[pid][c])continue;let aR=true,aS=true,val=null;for(let r=0;r<ROWS;r++){if(!gameState.revealed[pid][r][c]){aR=false;break;}if(val===null)val=gameState.hands[pid][r][c];else if(gameState.hands[pid][r][c]!==val)aS=false;}if(aR&&aS){gameState.eliminated[pid][c]=true;for(let r=0;r<ROWS;r++)gameState.discard.push(gameState.hands[pid][r][c]);broadcastToast(gpn(pid)+' Ã©limine une colonne de '+val+' !');broadcastBoom();}}}
function reshuffleDeck(){if(gameState.discard.length<=1)return;const t=gameState.discard.pop();gameState.deck=shuffle(gameState.discard);gameState.discard=[t];}
function endTurn(){
  const pid=gameState.players[gameState.currentPlayerIndex].id;
  if(gameState.lastRoundTriggeredBy===null&&isAllRev(pid)){gameState.lastRoundTriggeredBy=pid;gameState.lastRoundTurnsLeft=gameState.players.length-1;broadcastToast(gpn(pid)+' a tout rÃ©vÃ©lÃ© ! Dernier tour !');}
  if(gameState.lastRoundTriggeredBy!==null){gameState.lastRoundTurnsLeft--;if(gameState.lastRoundTurnsLeft<=0){endRound();return;}}
  gameState.currentPlayerIndex=(gameState.currentPlayerIndex+1)%gameState.players.length;
  gameState.turnPhase='draw';gameState.drawnCard=null;gameState.drawnFrom=null;gameState.drawnByPlayerId=null;
  broadcastState();
}
function isAllRev(pid){for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(gameState.eliminated[pid][c])continue;if(!gameState.revealed[pid][r][c])return false;}return true;}
function gpn(id){const p=gameState.players.find(x=>x.id===id);return p?p.name:'?';}
function endRound(){
  gameState.players.forEach(p=>{for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)gameState.revealed[p.id][r][c]=true;});
  const scores={};
  gameState.players.forEach(p=>{let s=0;for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++)if(!gameState.eliminated[p.id][c])s+=gameState.hands[p.id][r][c];scores[p.id]=s;});
  const tid=gameState.lastRoundTriggeredBy;
  if(tid){const mo=Math.min(...gameState.players.filter(p=>p.id!==tid).map(p=>scores[p.id]));if(scores[tid]>=mo){scores[tid]*=2;broadcastToast(gpn(tid)+' n\'a pas le score le plus bas ! Score doublÃ© !');}}
  gameState.roundScores=scores;
  gameState.players.forEach(p=>{gameState.totalScores[p.id]=(gameState.totalScores[p.id]||0)+scores[p.id];});
  gameState.phase=gameState.players.some(p=>gameState.totalScores[p.id]>=END_SCORE)?'game_over_reveal':'round_reveal';
  gameState.drawnCard=null;gameState.drawnByPlayerId=null;
  broadcastState();
}
function nextRound(){if(isHost)initRound();}

// â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFromState(){
  if(!gameState)return;
  const S={lobby:'screen-lobby',reveal_initial:'screen-game',playing:'screen-game',round_reveal:'screen-round-reveal',game_over_reveal:'screen-round-reveal',round_end:'screen-round-scores',game_over:'screen-final-scores'};
  showScreen(S[gameState.phase]||'screen-menu');
  switch(gameState.phase){
    case 'lobby': document.getElementById('lobby-code').textContent=roomCode;renderLobby();break;
    case 'reveal_initial':case 'playing': renderGame();break;
    case 'round_reveal':case 'game_over_reveal': renderRoundReveal(gameState.phase==='game_over_reveal');break;
    case 'round_end': renderRoundScores();break;
    case 'game_over': renderFinalScores();break;
  }
}
function renderRoundReveal(isGO){
  document.getElementById('reveal-subtitle').textContent=isGO?'Partie terminÃ©e !':'Manche '+gameState.round+' terminÃ©e !';
  const sorted=[...gameState.players].sort((a,b)=>(gameState.roundScores[a.id]||0)-(gameState.roundScores[b.id]||0));
  const best=gameState.roundScores[sorted[0].id]||0;
  document.getElementById('reveal-summary').innerHTML=sorted.map(p=>{
    const rs=gameState.roundScores[p.id]||0;let cards='';
    for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(gameState.eliminated[p.id][c])cards+='<div style="width:20px;height:28px;opacity:0"></div>';else{const v=gameState.hands[p.id][r][c];cards+=`<div class="card ${gcc(v)}" style="width:20px;height:28px;font-size:.55em;border-radius:3px;cursor:default">${v}</div>`;}}
    return `<div class="player-result ${rs===best?'best':''}"><div><strong>${p.name}</strong>${p.id===gameState.lastRoundTriggeredBy?' ğŸ””':''}${p.id===myPlayerId?' (vous)':''}<div style="display:flex;gap:2px;margin-top:4px">${cards}</div></div><span class="score-val">${rs>0?'+':''}${rs} pts</span></div>`;
  }).join('');
}
function showRoundScoreTable(){
  if(!gameState)return;
  if(gameState.phase==='game_over_reveal'){const s=[...gameState.players].sort((a,b)=>(gameState.totalScores[a.id]||0)-(gameState.totalScores[b.id]||0));gameState.players.forEach(p=>updateLeaderboard(p.name,p.id===s[0].id));gameState.phase='game_over';}
  else gameState.phase='round_end';
  if(isHost)broadcastState();else renderFromState();
}
function renderGame(){
  const isMT=gameState.phase==='playing'&&gameState.players[gameState.currentPlayerIndex]?.id===myPlayerId;
  document.getElementById('round-info').textContent='Manche '+gameState.round;
  const st=document.getElementById('game-status');
  if(gameState.phase==='reveal_initial'){const rv=gameState.initialReveals[myPlayerId]||0;st.textContent=rv<2?'Retournez '+(2-rv)+' carte(s)':'En attente des autres...';}
  else if(gameState.phase==='playing'){
    const cp=gameState.players[gameState.currentPlayerIndex];
    if(isMT){const M={draw:'Piochez une carte',drawn_from_pile:'ğŸ“Œ Placez le '+gameState.drawnCard+' OU dÃ©faussez',place_mandatory:'ğŸ“Œ Vous DEVEZ placer le '+gameState.drawnCard,must_reveal:'ğŸ‘† Retournez une carte'};st.textContent=M[gameState.turnPhase]||'Ã€ vous';}
    else{const extra={drawn_from_pile:' â€” a piochÃ© '+gameState.drawnCard,place_mandatory:' â€” doit placer '+gameState.drawnCard,must_reveal:' â€” doit retourner une carte'};st.textContent='Tour de '+cp.name+(gameState.drawnCard!==null?extra[gameState.turnPhase]||'':'');}
    if(gameState.lastRoundTriggeredBy)st.textContent+=' ğŸ”” Dernier tour !';
  }
  const dt=gameState.discard?.length?gameState.discard[gameState.discard.length-1]:null,dc=gameState.deck?.length||0;
  let ph=`<div class="pile"><div class="pile-label">Pioche (${dc})</div><div class="card face-down" onclick="clickDeck()"></div></div>`;
  ph+=`<div class="pile"><div class="pile-label">DÃ©fausse</div>${dt!==null?`<div class="card ${gcc(dt)}" onclick="clickDiscard()">${dt}</div>`:'<div class="card face-down" style="opacity:.3"></div>'}</div>`;
  if(gameState.drawnCard!==null&&gameState.drawnByPlayerId){const bm=gameState.drawnByPlayerId===myPlayerId;ph+=`<div class="pile"><div class="pile-label">${bm?'En main':gpn(gameState.drawnByPlayerId)}</div>`;if(isMT&&gameState.turnPhase==='drawn_from_pile')ph+=`<div class="card ${gcc(gameState.drawnCard)} highlight" onclick="discardDrawn()">${gameState.drawnCard}</div><div style="font-size:.65em;color:#e74c3c;margin-top:2px">Tap=dÃ©fausser</div>`;else ph+=`<div class="card ${gcc(gameState.drawnCard)} highlight">${gameState.drawnCard}</div>${isMT&&gameState.turnPhase==='place_mandatory'?'<div style="font-size:.65em;color:#f1c40f;margin-top:2px">Placez sur grille</div>':''}`;ph+='</div>';}
  document.getElementById('piles-area').innerHTML=ph;
  const ordered=[...gameState.players].sort((a,b)=>a.id===myPlayerId?-1:b.id===myPlayerId?1:0);
  document.getElementById('players-area').innerHTML=ordered.map(p=>{
    const isMe=p.id===myPlayerId,isCur=gameState.phase==='playing'&&gameState.players[gameState.currentPlayerIndex]?.id===p.id;
    const vis=cvs(p.id),tot=gameState.totalScores[p.id]||0;let cards='';
    for(let r=0;r<ROWS;r++){cards+='<div class="card-row">';for(let c=0;c<COLS;c++){if(gameState.eliminated[p.id][c])cards+='<div class="card eliminated"></div>';else if(gameState.revealed[p.id][r][c]){const v=gameState.hands[p.id][r][c];cards+=`<div class="card ${gcc(v)}">${v}</div>`;}else{const sel=ics(p.id,r,c);cards+=`<div class="card face-down ${sel?'selectable':''}" onclick="clickCard('${p.id}',${r},${c})"></div>`;}}cards+='</div>';}
    return `<div class="player-zone ${isCur?'current-turn':''} ${isMe?'is-me':''}"><div class="player-header"><span class="player-name">${p.name}${isMe?' (vous)':''}</span><span>${isCur?'<span class="turn-indicator">â–¶ </span>':''}<span class="player-score">Visible:${vis} | Total:${tot}</span></span></div><div class="card-container">${cards}</div></div>`;
  }).join('');
  const ab=document.getElementById('action-bar');
  if(isMT&&gameState.turnPhase==='drawn_from_pile'){ab.style.display='';ab.innerHTML=`<button class="danger" onclick="discardDrawn()">ğŸ—‘ï¸ DÃ©fausser le ${gameState.drawnCard}</button>`;}
  else if(isMT&&gameState.turnPhase==='must_reveal'){ab.style.display='';ab.innerHTML='<div style="color:#f1c40f;font-weight:600;padding:8px">ğŸ‘† Cliquez sur une carte face cachÃ©e</div>';}
  else{ab.style.display='none';ab.innerHTML='';}
}
function ics(pid,r,c){if(gameState.eliminated[pid][c])return false;const isMe=pid===myPlayerId;if(gameState.phase==='reveal_initial')return isMe&&!gameState.revealed[pid][r][c]&&(gameState.initialReveals[pid]||0)<2;if(gameState.phase==='playing'){const isMT=gameState.players[gameState.currentPlayerIndex]?.id===myPlayerId;if(!isMe||!isMT)return false;if(gameState.turnPhase==='must_reveal')return!gameState.revealed[pid][r][c];if(gameState.turnPhase==='drawn_from_pile'||gameState.turnPhase==='place_mandatory')return true;}return false;}
function gcc(v){if(v<=-2)return 'val-neg2';if(v===-1)return 'val-neg1';if(v===0)return 'val-0';return 'val-'+v;}
function cvs(pid){let s=0;for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){if(gameState.eliminated[pid][c])continue;if(gameState.revealed[pid][r][c])s+=gameState.hands[pid][r][c];}return s;}

function clickDeck(){const isMT=gameState.phase==='playing'&&gameState.players[gameState.currentPlayerIndex]?.id===myPlayerId;if(!isMT||gameState.turnPhase!=='draw')return;performAction({type:'draw_deck'});}
function clickDiscard(){const isMT=gameState.phase==='playing'&&gameState.players[gameState.currentPlayerIndex]?.id===myPlayerId;if(!isMT||gameState.turnPhase!=='draw')return;performAction({type:'draw_discard'});}
function clickCard(pid,row,col){if(gameState.phase==='reveal_initial'){if(pid!==myPlayerId)return;performAction({type:'reveal',row,col});return;}if(gameState.phase==='playing'){const isMT=gameState.players[gameState.currentPlayerIndex]?.id===myPlayerId;if(!isMT||pid!==myPlayerId)return;if(gameState.turnPhase==='must_reveal'){if(!gameState.revealed[pid][row][col])performAction({type:'reveal_card',row,col});return;}if(gameState.turnPhase==='drawn_from_pile'||gameState.turnPhase==='place_mandatory'){if(!gameState.eliminated[pid][col])performAction({type:'place_card',row,col});return;}}}
function discardDrawn(){performAction({type:'discard_drawn'});}

function renderRoundScores(){
  const sorted=[...gameState.players].sort((a,b)=>(gameState.totalScores[a.id]||0)-(gameState.totalScores[b.id]||0));
  let h='<thead><tr><th>Joueur</th><th>Manche</th><th>Total</th></tr></thead><tbody>';
  sorted.forEach((p,i)=>{const rs=gameState.roundScores[p.id]||0,ts=gameState.totalScores[p.id]||0;h+=`<tr${i===0?' class="winner"':''}><td>${i===0?'<span class="winner-name">':''}${p.name}${p.id===gameState.lastRoundTriggeredBy?' ğŸ””':''}${p.id===myPlayerId?' (vous)':''}${i===0?'</span>':''}</td><td>${rs>0?'+':''}${rs}</td><td class="total">${ts}</td></tr>`;});
  document.getElementById('round-scores-table').innerHTML=h+'</tbody>';
  document.getElementById('next-round-btn').style.display=isHost?'':'none';
}
function renderFinalScores(){
  const sorted=[...gameState.players].sort((a,b)=>(gameState.totalScores[a.id]||0)-(gameState.totalScores[b.id]||0));
  document.getElementById('final-winner-banner').innerHTML=`<div class="winner-name" style="font-size:1.8em">ğŸ‰ ${sorted[0].name} remporte la partie ! ğŸ‰</div>`;
  let h='<thead><tr><th>ğŸ†</th><th>Joueur</th><th>Score</th></tr></thead><tbody>';
  sorted.forEach((p,i)=>{h+=`<tr${i===0?' class="winner"':''}><td>${['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'][i]||i+1}</td><td>${i===0?'<span class="winner-name">':''}${p.name}${p.id===myPlayerId?' (vous)':''}${i===0?'</span>':''}</td><td class="total">${gameState.totalScores[p.id]||0}</td></tr>`;});
  document.getElementById('final-scores-table').innerHTML=h+'</tbody>';
  renderLeaderboard('final-leaderboard');
}

function showRules(){showModal('RÃ¨gles Skyjo',`<div style="text-align:left;font-size:.85em;max-height:60vh;overflow-y:auto;line-height:1.6"><b>But :</b> Avoir le score le plus bas.<br><br><b>DÃ©but :</b> Retournez 2 cartes. Celui avec la plus haute somme commence.<br><br><b>Tour :</b><br>â€¢ Pioche : placez OU dÃ©faussez et retournez une carte<br>â€¢ DÃ©fausse : vous DEVEZ placer la carte<br><br><b>Colonnes identiques :</b> Ã©liminÃ©es !<br><br><b>Score doublÃ©</b> si le dÃ©clencheur n'a pas le score le plus bas.<br><br><b>Fin :</b> Quand un joueur atteint 100 points.</div>`,[{text:'Compris !',action:'closeModal()'}]);}
function showModal(title,text,buttons){document.getElementById('modal-title').textContent=title;document.getElementById('modal-text').innerHTML=text;document.getElementById('modal-buttons').innerHTML=buttons.map(b=>`<button onclick="${b.action}">${b.text}</button>`).join('');document.getElementById('modal').classList.add('active');}
function closeModal(){document.getElementById('modal').classList.remove('active');}
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);}

Object.assign(window,{createGame,joinGame,showJoinScreen,showScreen,leaveLobby,backToMenu,startGame,nextRound,clickDeck,clickDiscard,clickCard,discardDrawn,toggleFullscreen,closeFsTip,showRules,showModal,closeModal,copyCode,showRoundScoreTable,cancelConnect,retryConnect});

window.addEventListener('load',()=>{
  const room=new URLSearchParams(window.location.search).get('room');
  if(room){document.getElementById('room-input').value=room;showJoinScreen();}
  renderLeaderboard('menu-leaderboard');
});
</script>
</body>
</html>
