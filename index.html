<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Sky Joe</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
</head>
<body>

<script>
'use strict';

/* ===============================
   Ã‰TAT GLOBAL
=================================*/

let peer=null, myId=null, isHost=false;
let hostConn=null, clientConns={};

let G={
  players:[],
  deck:[],
  discard:[],
  phase:'lobby',
  currentTurn:0,
  finalRound:false,
  finalBy:null,
  round:1,
  initCounts:{}
};

/* ===============================
   UTILS
=================================*/

function shuffle(a){
  const r=[...a];
  for(let i=r.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [r[i],r[j]]=[r[j],r[i]];
  }
  return r;
}

function buildDeck(){
  const d=[];
  for(let i=0;i<5;i++)d.push(-2);
  for(let i=0;i<10;i++)d.push(-1);
  for(let i=0;i<15;i++)d.push(0);
  for(let v=1;v<=12;v++)
    for(let i=0;i<10;i++)d.push(v);
  return shuffle(d);
}

/* ===============================
   ROOM STATE (CORRIGÃ‰)
=================================*/

function roomState(){
  return{
    phase:G.phase,
    currentTurn:G.currentTurn,
    deck_count:G.deck.length,
    discard:G.discard,
    round:G.round,
    initCounts:G.initCounts,
    finalRound:G.finalRound,
    finalBy:G.finalBy,
    players:G.players.map(p=>({
      id:p.id,
      name:p.name,
      total:p.total||0
    }))
  };
}

/* ===============================
   FIX CRITIQUE ICI
=================================*/

function applyRoomState(s){

  G.phase=s.phase;
  G.currentTurn=s.currentTurn;

  // ðŸ”¥ FIX IMPORTANT
  if(!isHost){
    G.deck = new Array(s.deck_count);
  }

  G.discard=s.discard||[];
  G.round=s.round;
  G.initCounts=s.initCounts||{};
  G.finalRound=s.finalRound;
  G.finalBy=s.finalBy;

  if(s.players){
    s.players.forEach(sp=>{
      const ex=G.players.find(p=>p.id===sp.id);
      if(ex){
        ex.name=sp.name;
        ex.total=sp.total;
      }else{
        G.players.push({...sp,cards:[]});
      }
    });
  }
}

/* ===============================
   ACTIONS HÃ”TE
=================================*/

function processAction(pid, action){

  const player=G.players.find(p=>p.id===pid);
  if(!player)return;

  if(action.type==='draw_deck'){

    console.log("Deck size before draw:",G.deck.length);

    if(G.deck.length===0)return;

    const card=G.deck.pop();

    console.log("Card drawn:",card);

    player.held=card;
    G.phase='place';

    broadcastState();
  }
}

/* ===============================
   NETWORK
=================================*/

function sendTo(id,msg){
  const c=clientConns[id];
  if(c&&c.open)c.send(msg);
}

function broadcastState(){
  const state=roomState();
  Object.values(clientConns).forEach(c=>{
    if(c&&c.open)c.send({type:'state_upd',roomState:state});
  });
}

/* ===============================
   FIN
=================================*/

</script>

</body>
</html>
